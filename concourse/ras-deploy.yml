resources:
- name: ras-party-source
  type: git
  source:
    uri: https://github.com/ONSdigital/ras-party.git
    branch: master

- name: ras-secure-message-source
  type: git
  source:
    uri: https://github.com/ONSdigital/ras-secure-message.git
    branch: master

- name: ras-backstage-source
  type: git
  source:
    uri: https://github.com/ONSdigital/ras-backstage.git
    branch: master

- name: ras-backstage-ui-source
  type: git
  source:
    uri: https://github.com/ONSdigital/ras-backstage-ui.git
    branch: tbl109-pipelines

- name: ras-api-gateway-source
  type: git
  source:
    uri: https://github.com/ONSdigital/ras-api-gateway.git
    branch: master

- name: ras-collection-instrument-source
  type: git
  source:
    uri: https://github.com/ONSdigital/ras-collection-instrument.git
    branch: master

- name: ras-frontstage-source
  type: git
  source:
    uri: https://github.com/ONSdigital/ras-frontstage.git
    branch: master

- name: django-oauth2-test-source
  type: git
  source:
    uri: https://github.com/ONSdigital/django-oauth2-test.git

- name: ras-integration-tests-source
  type: git
  source:
    uri: https://github.com/ONSdigital/ras-integration-tests.git

- name: cf-resource-dev
  type: cf
  source:
    api: {{cloudfoundry_api}}
    username: {{cloudfoundry_email}}
    password: {{cloudfoundry_password}}
    organization: rmras
    space: dev
    skip_cert_check: true

- name: cf-resource-test
  type: cf
  source:
    api: {{cloudfoundry_api}}
    username: {{cloudfoundry_email}}
    password: {{cloudfoundry_password}}
    organization: rmras
    space: test
    skip_cert_check: true

jobs:
- name: ras-party-dev-deploy
  plan:
  - get: ras-party-source
    trigger: true
  - put: cf-resource-dev
    params:
      current_app_name: concourse-ras-party.dev
      manifest: ras-party-source/manifest.yml
      path: ras-party-source
      environment_variables:
        SECURITY_USER_NAME: {{dev_security_user_name}}
        SECURITY_USER_PASSWORD: {{dev_security_user_password}}
        case-service.host: 'casesvc-dev.{{cf_apps_domain}}'
        case-service.port: '80'
        collectionexercise-service.host: 'collectionexercisesvc-dev.{{cf_apps_domain}}'
        collectionexercise-service.port: '80'
        survey-service.host: 'surveysvc-dev.{{cf_apps_domain}}'
        survey-service.port: '80'
        oauth2-service.host: 'concourse-django-oauth2-testdev.{{cf_apps_domain}}'
        oauth2-service.port: '80'
        iac-service.host: 'iacsvc-dev.{{cf_apps_domain}}'
        iac-service.port: '80'
        frontstage-service.host: 'ras-frontstage-dev.{{cf_apps_domain}}'
        frontstage-service.port: '80'
        feature.send_email_to_gov_notify: 'false'
        gov-uk-notify-service.gov_notify_api_key: {{notify_api_key}}
        gov-uk-notify-service.gov_notify_template_id: '53c59576-8c3b-4298-99d1-b245ddd28500'
        gov-uk-notify-service.gov_notify_service_id: 'ce3674b1-7b08-4377-a6a7-05b5722d4ea5'

- name: ras-secure-message-dev-deploy
  plan:
  - get: ras-secure-message-source
    trigger: true
  - put: cf-resource-dev
    params:
      current_app_name: concourse-ras-secure-message.dev
      manifest: ras-secure-message-source/manifest.yml
      path: ras-secure-message-source
      environment_variables:
        DEV_PORT: '8080'
        JWT_ALGORITHM: 'HS256'
        JWT_SECRET: {{dev_secret_key}}
        NOFITY_CASE_SERVICE: '1'
        NOTIFICATION_API_KEY: {{notify_api_key}}
        SERVICE_ID: 'aa1de51c-955b-4d83-83b2-d266525feacd'
        NOTIFICATION_TEMPLATE_ID: 'f6404844-a994-428c-a5d7-45a4e1cfff4b'
        NOTIFY_VIA_GOV_NOTIFY: '1'
        ONS_ENV: 'dev'
        RAS_PARTY_SERVICE_PORT: '80'
        RAS_PARTY_SERVICE_HOST: 'concourse-ras-partydev.{{cf_apps_domain}}'
        RAS_SM_PATH: '/home/vcap/app'
        SECURITY_USER_NAME: {{dev_security_user_name}}
        SECURITY_USER_PASSWORD: {{dev_security_user_password}}
        SMS_LOG_LEVEL: 'DEBUG'
        SM_JWT_ENCRYPT: '0'

- name: ras-backstage-dev-deploy
  plan:
  - get: ras-backstage-source
    trigger: true
  - put: cf-resource-dev
    params:
      current_app_name: concourse-ras-backstage.dev
      manifest: ras-backstage-source/manifest.yml
      path: ras-backstage-source
      environment_variables:
        SECURITY_USER_NAME: {{dev_security_user_name}}
        SECURITY_USER_PASSWORD: {{dev_security_user_password}}
        case-service.host: 'casesvc-dev.{{cf_apps_domain}}'
        case-service.port: '80'
        collectionexercise-service.host: 'collectionexercisesvc-dev.{{cf_apps_domain}}'
        collectionexercise-service.port: '80'
        survey-service.host: 'surveysvc-dev.{{cf_apps_domain}}'
        survey-service.port: '80'
        oauth2-service.host: 'concourse-django-oauth2-testdev.{{cf_apps_domain}}'
        oauth2-service.port: '80'
        party-service.host: 'concourse-ras-partydev.{{cf_apps_domain}}'
        party-service.port: '80'
        secure-message-service.host: 'concourse-ras-secure-messagedev.{{cf_apps_domain}}'
        secure-message-service.port: '80'
        collection-instrument-service.host: 'ras-collection-instrument-dev.{{cf_apps_domain}}'
        collection-instrument-service.port: '80'

- name: ras-backstage-ui-dev-deploy
  plan:
  - get: ras-backstage-ui-source
    trigger: true
  - put: cf-resource-dev
    params:
      current_app_name: concourse-ras-backstage-ui.dev
      manifest: ras-backstage-ui-source/manifest.yml
      path: ras-backstage-ui-source
      environment_variables:
        ONS_ENV: 'dev'
        SECURITY_USER_NAME: {{dev_security_user_name}}
        SECURITY_USER_PASSWORD: {{dev_security_user_password}}

- name: ras-api-gateway-dev-deploy
  plan:
  - get: ras-api-gateway-source
    trigger: true
  - put: cf-resource-dev
    params:
      current_app_name: concourse-ras-api-gateway.dev
      manifest: ras-api-gateway-source/manifest.yml
      path: ras-api-gateway-source
      environment_variables:
        ONS_ENV: 'dev'
        RAS_COLLECTION_INSTRUMENT_SERVICE_HOST: 'concourse-ras-collection-instrumentdev.{{cf_apps_domain}}'
        RAS_COLLECTION_INSTRUMENT_SERVICE_PORT: '80'
        RAS_PARTY_SERVICE_HOST: 'concourse-ras-partydev.{{cf_apps_domain}}'
        RAS_PARTY_SERVICE_PORT: '80'
        RAS_SECURE_MESSAGING_SERVICE_HOST: 'concourse-ras-secure-messagedev.{{cf_apps_domain}}'
        RAS_SECURE_MESSAGING_SERVICE_PORT: '80'
        RM_ACTION_SERVICE_HOST: 'actionsvc-dev.{{cf_apps_domain}}'
        RM_ACTION_SERVICE_PORT: '80'
        RM_CASE_SERVICE_HOST: 'casesvc-dev.{{cf_apps_domain}}'
        RM_CASE_SERVICE_PORT: '80'
        RM_COLLECTIONEXERCISE_SERVICE_HOST: 'collectionexercisesvc-dev.{{cf_apps_domain}}'
        RM_COLLECTIONEXERCISE_SERVICE_PORT: '80'
        RM_IAC_SERVICE_HOST: 'iacsvc-dev.{{cf_apps_domain}}'
        RM_IAC_SERVICE_PORT: '80'
        RM_NOTIFY_GATEWAY_SERVICE_HOST: 'notifygatewaysvc-dev.{{cf_apps_domain}}'
        RM_NOTIFY_GATEWAY_SERVICE_PORT: '80'
        RM_SAMPLE_SERVICE_HOST: 'samplesvc-dev.{{cf_apps_domain}}'
        RM_SAMPLE_SERVICE_PORT: '80'
        RM_SURVEY_SURVEY_HOST: 'surveysvc-dev.{{cf_apps_domain}}'
        RM_SURVEY_SURVEY_PORT: '80'
        SECURITY_USER_NAME: {{dev_security_user_name}}
        SECURITY_USER_PASSWORD: {{dev_security_user_password}}

- name: ras-collection-instrument-dev-deploy
  plan:
  - get: ras-collection-instrument-source
    trigger: true
  - put: cf-resource-dev
    params:
      current_app_name: concourse-ras-collection-instrument.dev
      manifest: ras-collection-instrument-source/manifest.yml
      path: ras-collection-instrument-source
      environment_variables:
        API_GATEWAY_CASE_URL: 'http://concourse-ras-api-gatewaydev.{{cf_apps_domain}}:80/cases/'
        API_GATEWAY_COLLECTION_EXERCISE_URL: 'http://concourse-ras-api-gatewaydev.{{cf_apps_domain}}:80/collectionexercises/'
        API_HOST: 'concourse-ras-api-gatewaydev.{{cf_apps_domain}}'
        API_PORT: '80'
        ONS_ENV: 'dev'
        RABBITMQ_AMQP: {{dev_rabbitmq_amqp}}
        SECURITY_USER_NAME: {{dev_security_user_name}}
        SECURITY_USER_PASSWORD: {{dev_security_user_password}}

- name: ras-frontstage-dev-deploy
  plan:
  - get: ras-frontstage-source
    trigger: true
  - put: cf-resource-dev
    params:
      current_app_name: concourse-ras-frontstage.dev
      manifest: ras-frontstage-source/manifest.yml
      path: ras-frontstage-source
      environment_variables:
        API_GATEWAY_AGGREGATED_SURVEYS_URL: 'http://concourse-ras-api-gatewaydev.{{cf_apps_domain}}/api/1.0.0/surveys/'
        API_GATEWAY_COLLECTION_INSTRUMENT_URL: 'http://concourse-ras-api-gatewaydev.{{cf_apps_domain}}/collection-instrument-api/1.0.2/'
        API_GATEWAY_PARTY_URL: 'http://concourse-ras-api-gatewaydev.{{cf_apps_domain}}/party-api/1.0.4/'
        API_GATEWAY_SURVEYS_URL: 'http://concourse-ras-api-gatewaydev.{{cf_apps_domain}}/surveys/'
        DEV_PORT: '8080'
        JWT_ALGORITHM: 'HS256'
        JWT_SECRET: {{dev_secret_key}}
        ONS_ENV: 'test'
        ONS_OAUTH_HOST: 'concourse-django-oauth2-testdev.{{cf_apps_domain}}'
        ONS_OAUTH_PROTOCOL: 'http'
        RAS_API_GATEWAY_SERVICE_HOST: 'concourse-ras-api-gatewaydev.{{cf_apps_domain}}'
        RAS_API_GATEWAY_SERVICE_PORT: '80'
        RAS_COLLECTION_INSTRUMENT_SERVICE_HOST: 'concourse-ras-collection-instrumentdev.{{cf_apps_domain}}'
        RAS_COLLECTION_INSTRUMENT_SERVICE_PORT: '80'
        RAS_FRONTSTAGE_CLIENT_ID: 'ons@ons.gov'
        RAS_FRONTSTAGE_CLIENT_SECRET: 'password'
        RAS_FRONTSTAGE_LOGGING_LEVEL: 'DEBUG'
        RAS_PARTY_SERVICE_HOST: 'concourse-ras-partydev.{{cf_apps_domain}}'
        RAS_PARTY_SERVICE_PORT: '80'
        RAS_SECURE_MESSAGE_SERVICE_HOST: 'concourse-ras-secure-messagedev.{{cf_apps_domain}}'
        RAS_SECURE_MESSAGE_SERVICE_PORT: '80'
        RM_CASE_SERVICE_HOST: 'casesvc-test.{{cf_apps_domain}}'
        RM_CASE_SERVICE_PORT: '80'
        RM_COLLECTION_EXERCISE_SERVICE_HOST: 'collectionexercisesvc-test.{{cf_apps_domain}}'
        RM_COLLECTION_EXERCISE_SERVICE_PORT: '80'
        RM_IAC_SERVICE_HOST: 'iacsvc-test.{{cf_apps_domain}}'
        RM_IAC_SERVICE_PORT: '80'
        RM_SURVEY_SERVICE_HOST: 'surveysvc-test.{{cf_apps_domain}}'
        RM_SURVEY_SERVICE_PORT: '80'
        SECRET_KEY: {{dev_secret_key}}
        SM_URL: 'http://concourse-ras-api-gatewaydev.{{cf_apps_domain}}'
        SECURITY_USER_NAME: {{dev_security_user_name}}
        SECURITY_USER_PASSWORD: {{dev_security_user_password}}

- name: django-oauth2-test-dev-deploy
  plan:
  - get: django-oauth2-test-source
    trigger: true
#    Create git_info file for info end point
  - task: git_info
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: paasmule/curl-ssl-git
          tag: "latest"
      inputs:
        - name: django-oauth2-test-source
      outputs:
        - name: django-oauth2-test-source-git-info
      run:
        path: sh
        args:
        - -exc
        - |
          cd django-oauth2-test-source
          branch=$(git rev-parse --abbrev-ref HEAD)
          url=$(git config --get remote.origin.url)
          commit=$(git rev-parse HEAD)
          repo=$(basename `git rev-parse --show-toplevel`)
          when=`date --utc +%FT%TZ`
          output=git_info
          echo '{' > ${output}
          echo   \"origin\": \"${url}\", >> ${output}
          echo   \"commit\": \"${commit}\", >> ${output}
          echo   \"branch\": \"${branch}\", >> ${output}
          echo   \"name\": \"${repo}\", >> ${output}
          echo   \"built\": \"${when}\" >> ${output}
          echo '}' >> ${output}
          cd ..
          cp -r django-oauth2-test-source/* django-oauth2-test-source-git-info

  - put: cf-resource-dev
    params:
      current_app_name: concourse-django-oauth2-test.dev
      manifest: django-oauth2-test-source-git-info/manifest.yml
      path: django-oauth2-test-source-git-info
      environment_variables:
        CSRF_ENABLED: "True"
        DEBUG: "False"
        DJANGO_SETTINGS_MODULE: proj.settings.cloud_foundry_settings
        OAUTH2_SUPER_USER: {{dev_oauth2_super_user}}
        OAUTH2_SUPER_USER_EMAIL: {{dev_oauth2_super_user_email}}
        OAUTH2_SUPER_USER_PASSWORD: {{dev_oauth2_super_user_password}}
        SECRET_KEY: {{dev_secret_key}}
        TESTING: "False"
        SECURITY_USER_NAME: {{dev_security_user_name}}
        SECURITY_USER_PASSWORD: {{dev_security_user_password}}


- name: ras-integration-tests
  plan:
  - get: ras-integration-tests-source
    trigger: true
  - get: ras-party-source
    passed: [ras-party-dev-deploy]
    trigger: true
  - get: ras-backstage-source
    passed: [ras-backstage-dev-deploy]
    trigger: true
  - get: ras-frontstage-source
    passed: [ras-frontstage-dev-deploy]
    trigger: true
  - get: ras-api-gateway-source
    passed: [ras-api-gateway-dev-deploy]
    trigger: true
  - get: ras-backstage-ui-source
    passed: [ras-backstage-ui-dev-deploy]
    trigger: true
  - get: django-oauth2-test-source
    passed: [django-oauth2-test-dev-deploy]
    trigger: true
  - get: ras-secure-message-source
    passed: [ras-secure-message-dev-deploy]
    trigger: true
  - get: ras-collection-instrument-source
    passed: [ras-collection-instrument-dev-deploy]
    trigger: true
  - task: build_test
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: python
          tag: "latest"
      inputs:
        - name: ras-integration-tests-source
      run:
        path: sh
        args:
        - -exc
        - |
          echo "Passed"

- name: ras-party-test-deploy
  plan:
  - get: ras-party-source
    passed: [ras-integration-tests]
    trigger: true
  - put: cf-resource-test
    params:
      current_app_name: concourse-ras-party.test
      manifest: ras-party-source/manifest.yml
      path: ras-party-source
      environment_variables:
        SECURITY_USER_NAME: {{test_security_user_name}}
        SECURITY_USER_PASSWORD: {{test_security_user_password}}
        case-service.host: 'casesvc-test.{{cf_apps_domain}}'
        case-service.port: '80'
        collectionexercise-service.host: 'collectionexercisesvc-test.{{cf_apps_domain}}'
        collectionexercise-service.port: '80'
        survey-service.host: 'surveysvc-test.{{cf_apps_domain}}'
        survey-service.port: '80'
        oauth2-service.host: 'concourse-django-oauth2-testtest.{{cf_apps_domain}}'
        oauth2-service.port: '80'
        iac-service.host: 'iacsvc-test.{{cf_apps_domain}}'
        iac-service.port: '80'
        frontstage-service.host: 'concourse-ras-frontstagetest.{{cf_apps_domain}}'
        frontstage-service.port: '80'
        api-gateway.host: 'concourse-ras-api-gatewaytest.{{cf_apps_domain}}'
        frontstage-service.port: '80'
        features.gateway_registration: 'true'
        feature.send_email_to_gov_notify: 'true'
        gov-uk-notify-service.gov_notify_api_key: {{notify_api_key}}
        gov-uk-notify-service.gov_notify_template_id: '53c59576-8c3b-4298-99d1-b245ddd28500'
        gov-uk-notify-service.gov_notify_service_id: 'ce3674b1-7b08-4377-a6a7-05b5722d4ea5'
        PUBLIC_EMAIL_VERIFICATION_URL: 'www.ons.gov.uk/surveys/get-started'
        SECRET_KEY: 'aardvark'
        EMAIL_TOKEN_SALT: 'sdc'

- name: ras-secure-message-test-deploy
  plan:
  - get: ras-secure-message-source
    passed: [ras-integration-tests]
    trigger: true
  - put: cf-resource-test
    params:
      current_app_name: concourse-ras-secure-message.test
      manifest: ras-secure-message-source/manifest.yml
      path: ras-secure-message-source
      environment_variables:
        DEV_PORT: '8080'
        NOFITY_CASE_SERVICE: '1'
        NOTIFICATION_API_KEY: {{notify_api_key}}
        SERVICE_ID: 'aa1de51c-955b-4d83-83b2-d266525feacd'
        NOTIFICATION_TEMPLATE_ID: 'f6404844-a994-428c-a5d7-45a4e1cfff4b'
        NOTIFY_VIA_GOV_NOTIFY: '1'
        NOTIFY_VIA_LOGGING: '1'
        ONS_ENV: 'test'
        RAS_PARTY_SERVICE_PORT: '80'
        RAS_PARTY_SERVICE_HOST: 'concourse-ras-partytest.{{cf_apps_domain}}'
        RAS_SM_PATH: '/home/vcap/app'
        SECURITY_USER_NAME: {{test_security_user_name}}
        SECURITY_USER_PASSWORD: {{test_security_user_password}}
        SMS_LOG_LEVEL: 'DEBUG'
        SM_JWT_ENCRYPT: '0'

- name: ras-backstage-test-deploy
  plan:
  - get: ras-backstage-source
    passed: [ras-integration-tests]
    trigger: true
  - put: cf-resource-test
    params:
      current_app_name: concourse-ras-backstage.test
      manifest: ras-backstage-source/manifest.yml
      path: ras-backstage-source
      environment_variables:
        SECURITY_USER_NAME: {{test_security_user_name}}
        SECURITY_USER_PASSWORD: {{test_security_user_password}}
        case-service.host: 'casesvc-test.{{cf_apps_domain}}'
        case-service.port: '80'
        collectionexercise-service.host: 'collectionexercisesvc-test.{{cf_apps_domain}}'
        collectionexercise-service.port: '80'
        survey-service.host: 'surveysvc-test.{{cf_apps_domain}}'
        survey-service.port: '80'
        oauth2-service.host: 'concourse-django-oauth2-testtest.{{cf_apps_domain}}'
        oauth2-service.port: '80'
        iac-service.host: 'iacsvc-test.{{cf_apps_domain}}'
        iac-service.port: '80'
        frontstage-service.host: 'concourse-ras-frontstagetest.{{cf_apps_domain}}'
        frontstage-service.port: '80'
        api-gateway.host: 'concourse-ras-api-gatewaytest.{{cf_apps_domain}}'
        api-gateway.port: '80'
        features.gateway_registration: 'true'
        party-service.host: 'concourse-ras-partytest.{{cf_apps_domain}}'
        party-service.port: '80'
        secure-message-service.host: 'concourse-ras-secure-messagetest.{{cf_apps_domain}}'
        secure-message-service.port: '80'
        collection-instrument-service.host: 'ras-collection-instrument-test.{{cf_apps_domain}}'
        collection-instrument-service.port: '80'
        SECRET_KEY: {{test_secret_key}}

- name: ras-backstage-ui-test-deploy
  plan:
  - get: ras-backstage-ui-source
    passed: [ras-integration-tests]
    trigger: true
  - put: cf-resource-test
    params:
      current_app_name: concourse-ras-backstage-ui.test
      manifest: ras-backstage-ui-source/manifest.yml
      path: ras-backstage-ui-source
      environment_variables:
        ONS_ENV: 'test'
        SECURITY_USER_NAME: {{test_security_user_name}}
        SECURITY_USER_PASSWORD: {{test_security_user_password}}

- name: ras-api-gateway-test-deploy
  plan:
  - get: ras-api-gateway-source
    passed: [ras-integration-tests]
    trigger: true
  - put: cf-resource-test
    params:
      current_app_name: concourse-ras-api-gateway.test
      manifest: ras-api-gateway-source/manifest.yml
      path: ras-api-gateway-source
      environment_variables:
        ONS_ENV: 'test'
        RAS_COLLECTION_INSTRUMENT_SERVICE_HOST: 'concourse-ras-collection-instrumenttest.{{cf_apps_domain}}'
        RAS_COLLECTION_INSTRUMENT_SERVICE_PORT: '80'
        RAS_PARTY_SERVICE_HOST: 'concourse-ras-partytest.{{cf_apps_domain}}'
        RAS_PARTY_SERVICE_PORT: '80'
        RAS_SECURE_MESSAGING_SERVICE_HOST: 'concourse-ras-secure-messagetest.{{cf_apps_domain}}'
        RAS_SECURE_MESSAGING_SERVICE_PORT: '80'
        RM_ACTION_SERVICE_HOST: 'actionsvc-test.{{cf_apps_domain}}'
        RM_ACTION_SERVICE_PORT: '80'
        RM_CASE_SERVICE_HOST: 'casesvc-test.{{cf_apps_domain}}'
        RM_CASE_SERVICE_PORT: '80'
        RM_COLLECTIONEXERCISE_SERVICE_HOST: 'collectionexercisesvc-test.{{cf_apps_domain}}'
        RM_COLLECTIONEXERCISE_SERVICE_PORT: '80'
        RM_IAC_SERVICE_HOST: 'iacsvc-test.{{cf_apps_domain}}'
        RM_IAC_SERVICE_PORT: '80'
        RM_NOTIFY_GATEWAY_SERVICE_HOST: 'notifygatewaysvc-test.{{cf_apps_domain}}'
        RM_NOTIFY_GATEWAY_SERVICE_PORT: '80'
        RM_SAMPLE_SERVICE_HOST: 'samplesvc-test.{{cf_apps_domain}}'
        RM_SAMPLE_SERVICE_PORT: '80'
        RM_SURVEY_SURVEY_HOST: 'surveysvc-test.{{cf_apps_domain}}'
        RM_SURVEY_SURVEY_PORT: '80'
        SECURITY_USER_NAME: {{test_security_user_name}}
        SECURITY_USER_PASSWORD: {{test_security_user_password}}
        LOG_FORMAT: 'json'

- name: ras-collection-instrument-test-deploy
  plan:
  - get: ras-collection-instrument-source
    passed: [ras-integration-tests]
    trigger: true
  - put: cf-resource-test
    params:
      current_app_name: concourse-ras-collection-instrument.test
      manifest: ras-collection-instrument-source/manifest.yml
      path: ras-collection-instrument-source
      environment_variables:
        API_GATEWAY_CASE_URL: 'http://concourse-ras-api-gatewaytest.{{cf_apps_domain}}:80/cases/'
        API_GATEWAY_COLLECTION_EXERCISE_URL: 'http://concourse-ras-api-gatewaytest.{{cf_apps_domain}}:80/collectionexercises/'
        API_GATEWAY_SURVEY_SERVICE_URL: 'http://concourse-ras-api-gatewaytest.{{cf_apps_domain}}:80/surveys/'
        API_HOST: 'concourse-ras-api-gatewaytest.{{cf_apps_domain}}'
        API_PORT: '80'
        ONS_ENV: 'test'
        RABBITMQ_AMQP: {{test_rabbitmq_amqp}}
        SECURITY_USER_NAME: {{test_security_user_name}}
        SECURITY_USER_PASSWORD: {{test_security_user_password}}
        ONS_CRYPTOKEY: {{test_ons_cryptokey}}
        JSON_SECRET_KEYS: {{test_json_secret_keys}}
        LOG_FORMAT: 'json'

- name: ras-frontstage-test-deploy
  plan:
  - get: ras-frontstage-source
    passed: [ras-integration-tests]
    trigger: true
  - put: cf-resource-test
    params:
      current_app_name: concourse-ras-frontstage.test
      manifest: ras-frontstage-source/manifest.yml
      path: ras-frontstage-source
      environment_variables:
        API_GATEWAY_AGGREGATED_SURVEYS_URL: 'http://concourse-ras-api-gatewaytest.{{cf_apps_domain}}/api/1.0.0/surveys/'
        API_GATEWAY_COLLECTION_INSTRUMENT_URL: 'http://concourse-ras-api-gatewaytest.{{cf_apps_domain}}/collection-instrument-api/1.0.2/'
        API_GATEWAY_PARTY_URL: 'http://concourse-ras-api-gatewaytest.{{cf_apps_domain}}/party-api/1.0.4/'
        API_GATEWAY_SURVEYS_URL: 'http://concourse-ras-api-gatewaytest.{{cf_apps_domain}}/surveys/'
        DEV_PORT: '8080'
        JWT_ALGORITHM: 'HS256'
        JWT_SECRET: {{test_secret_key}}
        ONS_ENV: 'test'
        ONS_OAUTH_HOST: 'concourse-django-oauth2-testtest.{{cf_apps_domain}}'
        ONS_OAUTH_PROTOCOL: 'http'
        RAS_API_GATEWAY_SERVICE_HOST: 'concourse-ras-api-gatewaytest.{{cf_apps_domain}}'
        RAS_API_GATEWAY_SERVICE_PORT: '80'
        RAS_COLLECTION_INSTRUMENT_SERVICE_HOST: 'concourse-ras-collection-instrumenttest.{{cf_apps_domain}}'
        RAS_COLLECTION_INSTRUMENT_SERVICE_PORT: '80'
        RAS_FRONTSTAGE_CLIENT_ID: 'ons@ons.gov'
        RAS_FRONTSTAGE_CLIENT_SECRET: 'password'
        RAS_FRONTSTAGE_LOGGING_LEVEL: 'DEBUG'
        RAS_PARTY_SERVICE_HOST: 'concourse-ras-partytest.{{cf_apps_domain}}'
        RAS_PARTY_SERVICE_PORT: '80'
        RAS_SECURE_MESSAGE_SERVICE_HOST: 'concourse-ras-secure-messagetest.{{cf_apps_domain}}'
        RAS_SECURE_MESSAGE_SERVICE_PORT: '80'
        RM_CASE_SERVICE_HOST: 'casesvc-test.{{cf_apps_domain}}'
        RM_CASE_SERVICE_PORT: '80'
        RM_COLLECTION_EXERCISE_SERVICE_HOST: 'collectionexercisesvc-test.{{cf_apps_domain}}'
        RM_COLLECTION_EXERCISE_SERVICE_PORT: '80'
        RM_IAC_SERVICE_HOST: 'iacsvc-test.{{cf_apps_domain}}'
        RM_IAC_SERVICE_PORT: '80'
        RM_SURVEY_SERVICE_HOST: 'surveysvc-test.{{cf_apps_domain}}'
        RM_SURVEY_SERVICE_PORT: '80'
        SECRET_KEY: {{test_secret_key}}
        SM_URL: 'http://concourse-ras-api-gatewaytest.{{cf_apps_domain}}'
        SECURITY_USER_NAME: {{test_security_user_name}}
        SECURITY_USER_PASSWORD: {{test_security_user_password}}

- name: django-oauth2-test-test-deploy
  plan:
  - get: django-oauth2-test-source
    passed: [ras-integration-tests]
    trigger: true
#    Create git_info file for info end point
  - task: git_info
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: paasmule/curl-ssl-git
          tag: "latest"
      inputs:
        - name: django-oauth2-test-source
      outputs:
        - name: django-oauth2-test-source-git-info
      run:
        path: sh
        args:
        - -exc
        - |
          cd django-oauth2-test-source
          branch=$(git rev-parse --abbrev-ref HEAD)
          url=$(git config --get remote.origin.url)
          commit=$(git rev-parse HEAD)
          repo=$(basename `git rev-parse --show-toplevel`)
          when=`date --utc +%FT%TZ`
          output=git_info
          echo '{' > ${output}
          echo   \"origin\": \"${url}\", >> ${output}
          echo   \"commit\": \"${commit}\", >> ${output}
          echo   \"branch\": \"${branch}\", >> ${output}
          echo   \"name\": \"${repo}\", >> ${output}
          echo   \"built\": \"${when}\" >> ${output}
          echo '}' >> ${output}
          cd ..
          cp -r django-oauth2-test-source/* django-oauth2-test-source-git-info
  - put: cf-resource-test
    params:
      current_app_name: concourse-django-oauth2-test.test
      manifest: django-oauth2-test-source-git-info/manifest.yml
      path: django-oauth2-test-source-git-info
      environment_variables:
        CSRF_ENABLED: "True"
        DEBUG: "False"
        DJANGO_SETTINGS_MODULE: proj.settings.cloud_foundry_settings
        OAUTH2_SUPER_USER: {{test_oauth2_super_user}}
        OAUTH2_SUPER_USER_EMAIL: {{test_oauth2_super_user_email}}
        OAUTH2_SUPER_USER_PASSWORD: {{test_oauth2_super_user_password}}
        SECRET_KEY: {{test_secret_key}}
        TESTING: "False"
        SECURITY_USER_NAME: {{test_security_user_name}}
        SECURITY_USER_PASSWORD: {{test_security_user_password}}
