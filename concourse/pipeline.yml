---
templates:
  ci:
    security_user: &ci_security_user
      actionSvc_connectionConfig_password: ((ci_security_user_password))
      actionSvc_connectionConfig_username: ((ci_security_user_name))
      caseSvc_connectionConfig_username: ((ci_security_user_name))
      caseSvc_connectionConfig_password: ((ci_security_user_password))
      collectionExerciseSvc_connectionConfig_username: ((ci_security_user_name))
      collectionExerciseSvc_connectionConfig_password: ((ci_security_user_password))
      collectionInstrumentSvc_connectionConfig_username: ((ci_security_user_name))
      collectionInstrumentSvc_connectionConfig_password: ((ci_security_user_password))
      internetAccessCodeSvc_connectionConfig_password: ((ci_security_user_password))
      internetAccessCodeSvc_connectionConfig_username: ((ci_security_user_name))
      partySvc_connectionConfig_username: ((ci_security_user_name))
      partySvc_connectionConfig_password: ((ci_security_user_password))
      sampleSvc_connectionConfig_username: ((ci_security_user_name))
      sampleSvc_connectionConfig_password: ((ci_security_user_password))
      security_user_name: ((ci_security_user_name))
      security_user_password: ((ci_security_user_password))
      surveySvc_connectionConfig_username: ((ci_security_user_name))
      surveySvc_connectionConfig_password: ((ci_security_user_password))
      CASE_USERNAME: ((ci_security_user_name))
      CASE_PASSWORD: ((ci_security_user_password))
      COLLECTION_EXERCISE_USERNAME: ((ci_security_user_name))
      COLLECTION_EXERCISE_PASSWORD: ((ci_security_user_password))
      COLLECTION_INSTRUMENT_USERNAME: ((ci_security_user_name))
      COLLECTION_INSTRUMENT_PASSWORD: ((ci_security_user_password))
      IAC_USERNAME: ((ci_security_user_name))
      IAC_PASSWORD: ((ci_security_user_password))
      PARTY_USERNAME: ((ci_security_user_name))
      PARTY_PASSWORD: ((ci_security_user_password))
      SAMPLE_USERNAME: ((ci_security_user_name))
      SAMPLE_PASSWORD: ((ci_security_user_password))
      SECURITY_USER_NAME: ((ci_security_user_name))
      SECURITY_USER_PASSWORD: ((ci_security_user_password))
      SURVEY_USERNAME: ((ci_security_user_name))
      SURVEY_PASSWORD: ((ci_security_user_password))

    all_services: &ci_all_services
    - ras-party-ci-deploy
    - ras-backstage-ci-deploy
    - ras-frontstage-ci-deploy
    - django-oauth2-test-ci-deploy
    - response-operations-ui-ci-deploy
    - ras-secure-message-ci-deploy
    - ras-collection-instrument-ci-deploy
    - rm-action-service-ci-deploy
    - rm-actionexporter-service-ci-deploy
    - rm-case-service-ci-deploy
    - rm-collection-exercise-ci-deploy
    - iac-service-ci-deploy
    - rm-notify-gateway-ci-deploy
    - rm-sample-service-ci-deploy
    - rm-sdx-gateway-ci-deploy
    - rm-survey-service-ci-deploy
    - sdc-uaa-ci-deploy

    service_endpoints_for_python: &ci_service_endpoints_for_python
      ACCOUNT_SERVICE_URL: http://ras-frontstage-ci.apps.devtest.onsclofo.uk
      ACTION_SERVICE_HOST: rm-action-service-ci.apps.devtest.onsclofo.uk
      ACTION_SERVICE_PORT: '80'
      ACTION_EXPORTER_HOST: rm-actionexporter-service-ci.apps.devtest.onsclofo.uk
      ACTION_EXPORTER_PORT: '80'
      BACKSTAGE_API_URL: http://ras-backstage-ci.apps.devtest.onsclofo.uk/backstage-api
      BACKSTAGE_SERVICE_HOST: ras-backstage-ci.apps.devtest.onsclofo.uk
      BACKSTAGE_SERVICE_PORT: '80'
      CASE_SERVICE_HOST: rm-case-service-ci.apps.devtest.onsclofo.uk
      CASE_SERVICE_PORT: '80'
      CASE_URL: http://rm-case-service-ci.apps.devtest.onsclofo.uk
      COLLECTION_EXERCISE_SERVICE_HOST: rm-collection-exercise-service-ci.apps.devtest.onsclofo.uk
      COLLECTION_EXERCISE_SERVICE_PORT: '80'
      COLLECTION_EXERCISE_HOST: rm-collection-exercise-service-ci.apps.devtest.onsclofo.uk
      COLLECTION_EXERCISE_PORT: '80'
      COLLECTION_EXERCISE_URL: http://rm-collection-exercise-service-ci.apps.devtest.onsclofo.uk
      COLLECTION_INSTRUMENT_SERVICE_HOST: ras-collection-instrument-ci.apps.devtest.onsclofo.uk
      COLLECTION_INSTRUMENT_SERVICE_PORT: '80'
      COLLECTION_INSTRUMENT_URL: http://ras-collection-instrument-ci.apps.devtest.onsclofo.uk
      DJANGO_SERVICE_HOST: django-oauth2-test-ci.apps.devtest.onsclofo.uk
      DJANGO_SERVICE_PORT: '80'
      FRONTSTAGE_SERVICE_HOST: ras-frontstage-ci.apps.devtest.onsclofo.uk
      FRONTSTAGE_SERVICE_PORT: '80'
      IAC_SERVICE_HOST: iac-service-ci.apps.devtest.onsclofo.uk
      IAC_SERVICE_PORT: '80'
      IAC_URL: http://iac-service-ci.apps.devtest.onsclofo.uk
      NOTIFY_GATEWAY_SERVICE_HOST: rm-notify-gateway-ci.apps.devtest.onsclofo.uk
      NOTIFY_GATEWAY_SERVICE_PORT: '80'
      OAUTH_URL: http://django-oauth2-test-ci.apps.devtest.onsclofo.uk
      PARTY_SERVICE_HOST: ras-party-ci.apps.devtest.onsclofo.uk
      PARTY_SERVICE_PORT: '80'
      PARTY_URL: http://ras-party-ci.apps.devtest.onsclofo.uk
      RM_CASE_SERVICE_HOST: rm-case-service-ci.apps.devtest.onsclofo.uk
      RM_CASE_SERVICE_PORT: '80'
      RM_COLLECTION_EXERCISE_SERVICE_HOST: rm-collection-exercise-service-ci.apps.devtest.onsclofo.uk
      RM_COLLECTION_EXERCISE_SERVICE_PORT: '80'
      RM_IAC_SERVICE_HOST: iac-service-ci.apps.devtest.onsclofo.uk
      RM_IAC_SERVICE_PORT: '80'
      RM_SAMPLE_SERVICE_HOST: rm-sample-service-ci.apps.devtest.onsclofo.uk
      RM_SAMPLE_SERVICE_PORT: '80'
      RM_SURVEY_SERVICE_HOST: rm-survey-service-ci.apps.devtest.onsclofo.uk
      RM_SURVEY_SERVICE_PORT: '80'
      RAS_CASE_SERVICE_HOST: rm-case-service-ci.apps.devtest.onsclofo.uk
      RAS_CASE_SERVICE_PORT: '80'
      RAS_COLLEX_SERVICE_HOST: rm-collection-exercise-service-ci.apps.devtest.onsclofo.uk
      RAS_COLLEX_SERVICE_PORT: '80'
      RAS_IAC_SERVICE_HOST: iac-service-ci.apps.devtest.onsclofo.uk
      RAS_IAC_SERVICE_PORT: '80'
      RAS_OAUTH_SERVICE_HOST: django-oauth2-test-ci.apps.devtest.onsclofo.uk
      RAS_OAUTH_SERVICE_PORT: '80'
      RAS_PARTY_SERVICE_HOST: ras-party-ci.apps.devtest.onsclofo.uk
      RAS_PARTY_SERVICE_PORT: '80'
      RAS_COLLECTION_INSTRUMENT_SERVICE_HOST: ras-collection-instrument-ci.apps.devtest.onsclofo.uk
      RAS_COLLECTION_INSTRUMENT_SERVICE_PORT: '80'
      RAS_PUBLIC_WEBSITE_HOST: ras-frontstage-ci.apps.devtest.onsclofo.uk
      RAS_PUBLIC_WEBSITE_PORT: '80'
      RAS_SECURE_MESSAGE_SERVICE_HOST: ras-secure-message-ci.apps.devtest.onsclofo.uk
      RAS_SECURE_MESSAGE_SERVICE_PORT: '80'
      RAS_SECURE_MESSAGING_SERVICE_HOST: ras-secure-message-ci.apps.devtest.onsclofo.uk
      RAS_SECURE_MESSAGING_SERVICE_PORT: '80'
      RAS_SURVEY_SERVICE_HOST: rm-survey-service-ci.apps.devtest.onsclofo.uk
      RAS_SURVEY_SERVICE_PORT: '80'
      RESPONSE_OPERATIONS_UI_HOST: response-operations-ui-ci.apps.devtest.onsclofo.uk
      RESPONSE_OPERATIONS_UI_PORT: '80'
      SAMPLE_SERVICE_HOST: rm-sample-service-ci.apps.devtest.onsclofo.uk
      SAMPLE_SERVICE_PORT: '80'
      SAMPLE_URL: http://rm-sample-service-ci.apps.devtest.onsclofo.uk
      SECURE_MESSAGE_SERVICE_HOST: ras-secure-message-ci.apps.devtest.onsclofo.uk
      SECURE_MESSAGE_SERVICE_PORT: '80'
      SECURE_MESSAGE_URL: http://ras-secure-message-ci.apps.devtest.onsclofo.uk
      SURVEY_SERVICE_HOST: rm-survey-service-ci.apps.devtest.onsclofo.uk
      SURVEY_SERVICE_PORT: '80'
      SURVEY_URL: http://rm-survey-service-ci.apps.devtest.onsclofo.uk
      UAA_SERVICE_URL: http://uaa-ci.apps.devtest.onsclofo.uk

    service_endpoints_for_java: &ci_service_endpoints_for_java
      actionSvc_connectionConfig_host: 'rm-action-service-ci.apps.devtest.onsclofo.uk'
      actionSvc_connectionConfig_port: '80'
      actionSvc_connectionConfig_scheme: 'http'
      caseSvc_connectionConfig_host: 'rm-case-service-ci.apps.devtest.onsclofo.uk'
      caseSvc_connectionConfig_port: '80'
      caseSvc_connectionConfig_scheme: 'http'
      collectionExerciseSvc_connectionConfig_host: 'rm-collection-exercise-service-ci.apps.devtest.onsclofo.uk'
      collectionExerciseSvc_connectionConfig_port: '80'
      collectionExerciseSvc_connectionConfig_scheme: 'http'
      collectionInstrumentSvc_connectionConfig_host: 'ras-collection-instrument-ci.apps.devtest.onsclofo.uk'
      collectionInstrumentSvc_connectionConfig_port: '80'
      collectionInstrumentSvc_connectionConfig_scheme: 'http'
      internetAccessCodeSvc_connectionConfig_host: 'iac-service-ci.apps.devtest.onsclofo.uk'
      internetAccessCodeSvc_connectionConfig_port: '80'
      internetAccessCodeSvc_connectionConfig_scheme: 'http'
      partySvc_connectionConfig_host: 'ras-party-ci.apps.devtest.onsclofo.uk'
      partySvc_connectionConfig_port: '80'
      partySvc_connectionConfig_scheme: 'http'
      sampleSvc_connectionConfig_host: 'rm-sample-service-ci.apps.devtest.onsclofo.uk'
      sampleSvc_connectionConfig_port: '80'
      sampleSvc_connectionConfig_scheme: 'http'
      surveySvc_connectionConfig_host: 'rm-survey-service-ci.apps.devtest.onsclofo.uk'
      surveySvc_connectionConfig_port: '80'
      surveySvc_connectionConfig_scheme: 'http'

    create_rm_redis: &ci_create_rm_redis
      put: create-rm-redis
      resource: cf-cli-resource-ci
      params:
        command: create-service
        service: elasticache-broker
        plan: small
        service_instance: rm-redis
        timeout: 1800
        wait_for_service: true

    create_rm_rabbitmq: &ci_create_rm_rabbitmq
      put: create-rm-rabbitmq
      resource: cf-cli-resource-ci
      params:
        command: create-service
        service: rabbitmq
        plan: standard
        service_instance: rm-rabbitmq
        timeout: 1800
        wait_for_service: true

    create_rm_pg_db: &ci_create_rm_pg_db
      put: create-database
      resource: cf-cli-resource-ci
      params:
        command: create-service
        service: rds
        plan: shared-psql
        service_instance: rm-pg-db
        timeout: 1800
        wait_for_service: true

  latest:
    security_user: &latest_security_user
      actionSvc_connectionConfig_password: ((latest_security_user_password))
      actionSvc_connectionConfig_username: ((latest_security_user_name))
      caseSvc_connectionConfig_username: ((latest_security_user_name))
      caseSvc_connectionConfig_password: ((latest_security_user_password))
      collectionExerciseSvc_connectionConfig_username: ((latest_security_user_name))
      collectionExerciseSvc_connectionConfig_password: ((latest_security_user_password))
      collectionInstrumentSvc_connectionConfig_username: ((latest_security_user_name))
      collectionInstrumentSvc_connectionConfig_password: ((latest_security_user_password))
      internetAccessCodeSvc_connectionConfig_password: ((latest_security_user_password))
      internetAccessCodeSvc_connectionConfig_username: ((latest_security_user_name))
      partySvc_connectionConfig_username: ((latest_security_user_name))
      partySvc_connectionConfig_password: ((latest_security_user_password))
      sampleSvc_connectionConfig_username: ((latest_security_user_name))
      sampleSvc_connectionConfig_password: ((latest_security_user_password))
      security_user_name: ((latest_security_user_name))
      security_user_password: ((latest_security_user_password))
      surveySvc_connectionConfig_username: ((latest_security_user_name))
      surveySvc_connectionConfig_password: ((latest_security_user_password))
      CASE_USERNAME: ((latest_security_user_name))
      CASE_PASSWORD: ((latest_security_user_password))
      COLLECTION_EXERCISE_USERNAME: ((latest_security_user_name))
      COLLECTION_EXERCISE_PASSWORD: ((latest_security_user_password))
      COLLECTION_INSTRUMENT_USERNAME: ((latest_security_user_name))
      COLLECTION_INSTRUMENT_PASSWORD: ((latest_security_user_password))
      IAC_USERNAME: ((latest_security_user_name))
      IAC_PASSWORD: ((latest_security_user_password))
      PARTY_USERNAME: ((latest_security_user_name))
      PARTY_PASSWORD: ((latest_security_user_password))
      SAMPLE_USERNAME: ((latest_security_user_name))
      SAMPLE_PASSWORD: ((latest_security_user_password))
      SECURITY_USER_NAME: ((latest_security_user_name))
      SECURITY_USER_PASSWORD: ((latest_security_user_password))
      SURVEY_USERNAME: ((latest_security_user_name))
      SURVEY_PASSWORD: ((latest_security_user_password))

    all_services: &latest_all_services
    - ras-party-latest-deploy
    - ras-backstage-latest-deploy
    - ras-frontstage-latest-deploy
    - django-oauth2-test-latest-deploy
    - response-operations-ui-latest-deploy
    - ras-secure-message-latest-deploy
    - ras-collection-instrument-latest-deploy
    - rm-action-service-latest-deploy
    - rm-actionexporter-service-latest-deploy
    - rm-case-service-latest-deploy
    - rm-collection-exercise-latest-deploy
    - iac-service-latest-deploy
    - rm-notify-gateway-latest-deploy
    - rm-sample-service-latest-deploy
    - rm-sdx-gateway-latest-deploy
    - rm-survey-service-latest-deploy
    - sdc-uaa-latest-deploy

    service_endpoints_for_python: &latest_service_endpoints_for_python
      ACCOUNT_SERVICE_URL: http://ras-frontstage-concourse-latest.apps.devtest.onsclofo.uk
      ACTION_SERVICE_HOST: rm-action-service-concourse-latest.apps.devtest.onsclofo.uk
      ACTION_SERVICE_PORT: '80'
      ACTION_EXPORTER_HOST: rm-actionexporter-service-concourse-latest.apps.devtest.onsclofo.uk
      ACTION_EXPORTER_PORT: '80'
      BACKSTAGE_API_URL: http://ras-backstage-concourse-latest.apps.devtest.onsclofo.uk/backstage-api
      BACKSTAGE_SERVICE_HOST: ras-backstage-concourse-latest.apps.devtest.onsclofo.uk
      BACKSTAGE_SERVICE_PORT: '80'
      CASE_SERVICE_HOST: rm-case-service-concourse-latest.apps.devtest.onsclofo.uk
      CASE_SERVICE_PORT: '80'
      CASE_URL: http://rm-case-service-concourse-latest.apps.devtest.onsclofo.uk
      COLLECTION_EXERCISE_SERVICE_HOST: rm-collection-exercise-service-concourse-latest.apps.devtest.onsclofo.uk
      COLLECTION_EXERCISE_SERVICE_PORT: '80'
      COLLECTION_EXERCISE_HOST: rm-collection-exercise-service-concourse-latest.apps.devtest.onsclofo.uk
      COLLECTION_EXERCISE_PORT: '80'
      COLLECTION_EXERCISE_URL: http://rm-collection-exercise-service-concourse-latest.apps.devtest.onsclofo.uk
      COLLECTION_INSTRUMENT_SERVICE_HOST: ras-collection-instrument-concourse-latest.apps.devtest.onsclofo.uk
      COLLECTION_INSTRUMENT_SERVICE_PORT: '80'
      COLLECTION_INSTRUMENT_URL: http://ras-collection-instrument-concourse-latest.apps.devtest.onsclofo.uk
      DJANGO_SERVICE_HOST: django-oauth2-test-concourse-latest.apps.devtest.onsclofo.uk
      DJANGO_SERVICE_PORT: '80'
      FRONTSTAGE_SERVICE_HOST: ras-frontstage-concourse-latest.apps.devtest.onsclofo.uk
      FRONTSTAGE_SERVICE_PORT: '80'
      IAC_SERVICE_HOST: iac-service-concourse-latest.apps.devtest.onsclofo.uk
      IAC_SERVICE_PORT: '80'
      IAC_URL: http://iac-service-concourse-latest.apps.devtest.onsclofo.uk
      NOTIFY_GATEWAY_SERVICE_HOST: rm-notify-gateway-concourse-latest.apps.devtest.onsclofo.uk
      NOTIFY_GATEWAY_SERVICE_PORT: '80'
      OAUTH_URL: http://django-oauth2-test-concourse-latest.apps.devtest.onsclofo.uk
      PARTY_SERVICE_HOST: ras-party-concourse-latest.apps.devtest.onsclofo.uk
      PARTY_SERVICE_PORT: '80'
      PARTY_URL: http://ras-party-concourse-latest.apps.devtest.onsclofo.uk
      RM_CASE_SERVICE_HOST: rm-case-service-concourse-latest.apps.devtest.onsclofo.uk
      RM_CASE_SERVICE_PORT: '80'
      RM_COLLECTION_EXERCISE_SERVICE_HOST: rm-collection-exercise-service-concourse-latest.apps.devtest.onsclofo.uk
      RM_COLLECTION_EXERCISE_SERVICE_PORT: '80'
      RM_IAC_SERVICE_HOST: iac-service-concourse-latest.apps.devtest.onsclofo.uk
      RM_IAC_SERVICE_PORT: '80'
      RM_SAMPLE_SERVICE_HOST: rm-sample-service-concourse-latest.apps.devtest.onsclofo.uk
      RM_SAMPLE_SERVICE_PORT: '80'
      RM_SURVEY_SERVICE_HOST: rm-survey-service-concourse-latest.apps.devtest.onsclofo.uk
      RM_SURVEY_SERVICE_PORT: '80'
      RAS_CASE_SERVICE_HOST: rm-case-service-concourse-latest.apps.devtest.onsclofo.uk
      RAS_CASE_SERVICE_PORT: '80'
      RAS_COLLEX_SERVICE_HOST: rm-collection-exercise-service-concourse-latest.apps.devtest.onsclofo.uk
      RAS_COLLEX_SERVICE_PORT: '80'
      RAS_IAC_SERVICE_HOST: iac-service-concourse-latest.apps.devtest.onsclofo.uk
      RAS_IAC_SERVICE_PORT: '80'
      RAS_OAUTH_SERVICE_HOST: django-oauth2-test-concourse-latest.apps.devtest.onsclofo.uk
      RAS_OAUTH_SERVICE_PORT: '80'
      RAS_PARTY_SERVICE_HOST: ras-party-concourse-latest.apps.devtest.onsclofo.uk
      RAS_PARTY_SERVICE_PORT: '80'
      RAS_COLLECTION_INSTRUMENT_SERVICE_HOST: ras-collection-instrument-concourse-latest.apps.devtest.onsclofo.uk
      RAS_COLLECTION_INSTRUMENT_SERVICE_PORT: '80'
      RAS_PUBLIC_WEBSITE_HOST: ras-frontstage-concourse-latest.apps.devtest.onsclofo.uk
      RAS_PUBLIC_WEBSITE_PORT: '80'
      RAS_SECURE_MESSAGE_SERVICE_HOST: ras-secure-message-concourse-latest.apps.devtest.onsclofo.uk
      RAS_SECURE_MESSAGE_SERVICE_PORT: '80'
      RAS_SECURE_MESSAGING_SERVICE_HOST: ras-secure-message-concourse-latest.apps.devtest.onsclofo.uk
      RAS_SECURE_MESSAGING_SERVICE_PORT: '80'
      RAS_SURVEY_SERVICE_HOST: rm-survey-service-concourse-latest.apps.devtest.onsclofo.uk
      RAS_SURVEY_SERVICE_PORT: '80'
      RESPONSE_OPERATIONS_UI_HOST: response-operations-ui-concourse-latest.apps.devtest.onsclofo.uk
      RESPONSE_OPERATIONS_UI_PORT: '80'
      SAMPLE_SERVICE_HOST: rm-sample-service-concourse-latest.apps.devtest.onsclofo.uk
      SAMPLE_SERVICE_PORT: '80'
      SAMPLE_URL: http://rm-sample-service-concourse-latest.apps.devtest.onsclofo.uk
      SECURE_MESSAGE_SERVICE_HOST: ras-secure-message-concourse-latest.apps.devtest.onsclofo.uk
      SECURE_MESSAGE_SERVICE_PORT: '80'
      SECURE_MESSAGE_URL: http://ras-secure-message-concourse-latest.apps.devtest.onsclofo.uk
      SURVEY_SERVICE_HOST: rm-survey-service-concourse-latest.apps.devtest.onsclofo.uk
      SURVEY_SERVICE_PORT: '80'
      SURVEY_URL: http://rm-survey-service-concourse-latest.apps.devtest.onsclofo.uk
      UAA_SERVICE_URL: http://uaa-concourse-latest.apps.devtest.onsclofo.uk

    service_endpoints_for_java: &latest_service_endpoints_for_java
      actionSvc_connectionConfig_host: 'rm-action-service-concourse-latest.apps.devtest.onsclofo.uk'
      actionSvc_connectionConfig_port: '80'
      actionSvc_connectionConfig_scheme: 'http'
      caseSvc_connectionConfig_host: 'rm-case-service-concourse-latest.apps.devtest.onsclofo.uk'
      caseSvc_connectionConfig_port: '80'
      caseSvc_connectionConfig_scheme: 'http'
      collectionExerciseSvc_connectionConfig_host: 'rm-collection-exercise-service-concourse-latest.apps.devtest.onsclofo.uk'
      collectionExerciseSvc_connectionConfig_port: '80'
      collectionExerciseSvc_connectionConfig_scheme: 'http'
      collectionInstrumentSvc_connectionConfig_host: 'ras-collection-instrument-concourse-latest.apps.devtest.onsclofo.uk'
      collectionInstrumentSvc_connectionConfig_port: '80'
      collectionInstrumentSvc_connectionConfig_scheme: 'http'
      internetAccessCodeSvc_connectionConfig_host: 'iac-service-concourse-latest.apps.devtest.onsclofo.uk'
      internetAccessCodeSvc_connectionConfig_port: '80'
      internetAccessCodeSvc_connectionConfig_scheme: 'http'
      partySvc_connectionConfig_host: 'ras-party-concourse-latest.apps.devtest.onsclofo.uk'
      partySvc_connectionConfig_port: '80'
      partySvc_connectionConfig_scheme: 'http'
      sampleSvc_connectionConfig_host: 'rm-sample-service-concourse-latest.apps.devtest.onsclofo.uk'
      sampleSvc_connectionConfig_port: '80'
      sampleSvc_connectionConfig_scheme: 'http'
      surveySvc_connectionConfig_host: 'rm-survey-service-concourse-latest.apps.devtest.onsclofo.uk'
      surveySvc_connectionConfig_port: '80'
      surveySvc_connectionConfig_scheme: 'http'

    create_rm_redis: &latest_create_rm_redis
      put: create-rm-redis
      resource: cf-cli-resource-latest
      params:
        command: create-service
        service: elasticache-broker
        plan: small
        service_instance: rm-redis
        timeout: 1800
        wait_for_service: true

    create_rm_rabbitmq: &latest_create_rm_rabbitmq
      put: create-rm-rabbitmq
      resource: cf-cli-resource-latest
      params:
        command: create-service
        service: rabbitmq
        plan: standard
        service_instance: rm-rabbitmq
        timeout: 1800
        wait_for_service: true

    create_rm_pg_db: &latest_create_rm_pg_db
      put: create-database
      resource: cf-cli-resource-latest
      params:
        command: create-service
        service: rds
        plan: shared-psql
        service_instance: rm-pg-db
        timeout: 1800
        wait_for_service: true

  preprod:
    security_user: &preprod_security_user
      actionSvc_connectionConfig_password: ((preprod_security_user_password))
      actionSvc_connectionConfig_username: ((preprod_security_user_name))
      caseSvc_connectionConfig_username: ((preprod_security_user_name))
      caseSvc_connectionConfig_password: ((preprod_security_user_password))
      collectionExerciseSvc_connectionConfig_username: ((preprod_security_user_name))
      collectionExerciseSvc_connectionConfig_password: ((preprod_security_user_password))
      collectionInstrumentSvc_connectionConfig_username: ((preprod_security_user_name))
      collectionInstrumentSvc_connectionConfig_password: ((preprod_security_user_password))
      internetAccessCodeSvc_connectionConfig_password: ((preprod_security_user_password))
      internetAccessCodeSvc_connectionConfig_username: ((preprod_security_user_name))
      partySvc_connectionConfig_username: ((preprod_security_user_name))
      partySvc_connectionConfig_password: ((preprod_security_user_password))
      sampleSvc_connectionConfig_username: ((preprod_security_user_name))
      sampleSvc_connectionConfig_password: ((preprod_security_user_password))
      security_user_name: ((preprod_security_user_name))
      security_user_password: ((preprod_security_user_password))
      surveySvc_connectionConfig_username: ((preprod_security_user_name))
      surveySvc_connectionConfig_password: ((preprod_security_user_password))
      CASE_USERNAME: ((preprod_security_user_name))
      CASE_PASSWORD: ((preprod_security_user_password))
      COLLECTION_EXERCISE_USERNAME: ((preprod_security_user_name))
      COLLECTION_EXERCISE_PASSWORD: ((preprod_security_user_password))
      COLLECTION_INSTRUMENT_USERNAME: ((preprod_security_user_name))
      COLLECTION_INSTRUMENT_PASSWORD: ((preprod_security_user_password))
      IAC_USERNAME: ((preprod_security_user_name))
      IAC_PASSWORD: ((preprod_security_user_password))
      PARTY_USERNAME: ((preprod_security_user_name))
      PARTY_PASSWORD: ((preprod_security_user_password))
      SAMPLE_USERNAME: ((preprod_security_user_name))
      SAMPLE_PASSWORD: ((preprod_security_user_password))
      SECURITY_USER_NAME: ((preprod_security_user_name))
      SECURITY_USER_PASSWORD: ((preprod_security_user_password))
      SURVEY_USERNAME: ((preprod_security_user_name))
      SURVEY_PASSWORD: ((preprod_security_user_password))

    all_services: &preprod_all_services
    - ras-party-preprod-deploy
    - ras-backstage-preprod-deploy
    - ras-frontstage-preprod-deploy
    - django-oauth2-test-preprod-deploy
    - response-operations-ui-preprod-deploy
    - ras-secure-message-preprod-deploy
    - ras-collection-instrument-preprod-deploy
    - rm-action-service-preprod-deploy
    - rm-actionexporter-service-preprod-deploy
    - rm-case-service-preprod-deploy
    - rm-collection-exercise-preprod-deploy
    - iac-service-preprod-deploy
    - rm-notify-gateway-preprod-deploy
    - rm-sample-service-preprod-deploy
    - rm-sdx-gateway-preprod-deploy
    - rm-survey-service-preprod-deploy
    - sdc-uaa-preprod-deploy

    service_endpoints_for_python: &preprod_service_endpoints_for_python
      ACCOUNT_SERVICE_URL: http://ras-frontstage-concourse-preprod.apps.devtest.onsclofo.uk
      ACTION_SERVICE_HOST: rm-action-service-concourse-preprod.apps.devtest.onsclofo.uk
      ACTION_SERVICE_PORT: '80'
      ACTION_EXPORTER_HOST: rm-actionexporter-service-concourse-preprod.apps.devtest.onsclofo.uk
      ACTION_EXPORTER_PORT: '80'
      BACKSTAGE_API_URL: http://ras-backstage-concourse-preprod.apps.devtest.onsclofo.uk/backstage-api
      BACKSTAGE_SERVICE_HOST: ras-backstage-concourse-preprod.apps.devtest.onsclofo.uk
      BACKSTAGE_SERVICE_PORT: '80'
      CASE_SERVICE_HOST: rm-case-service-concourse-preprod.apps.devtest.onsclofo.uk
      CASE_SERVICE_PORT: '80'
      CASE_URL: http://rm-case-service-concourse-preprod.apps.devtest.onsclofo.uk
      COLLECTION_EXERCISE_SERVICE_HOST: rm-collection-exercise-service-concourse-preprod.apps.devtest.onsclofo.uk
      COLLECTION_EXERCISE_SERVICE_PORT: '80'
      COLLECTION_EXERCISE_HOST: rm-collection-exercise-service-concourse-preprod.apps.devtest.onsclofo.uk
      COLLECTION_EXERCISE_PORT: '80'
      COLLECTION_EXERCISE_URL: http://rm-collection-exercise-service-concourse-preprod.apps.devtest.onsclofo.uk
      COLLECTION_INSTRUMENT_SERVICE_HOST: ras-collection-instrument-concourse-preprod.apps.devtest.onsclofo.uk
      COLLECTION_INSTRUMENT_SERVICE_PORT: '80'
      COLLECTION_INSTRUMENT_URL: http://ras-collection-instrument-concourse-preprod.apps.devtest.onsclofo.uk
      DJANGO_SERVICE_HOST: django-oauth2-test-concourse-preprod.apps.devtest.onsclofo.uk
      DJANGO_SERVICE_PORT: '80'
      FRONTSTAGE_SERVICE_HOST: ras-frontstage-concourse-preprod.apps.devtest.onsclofo.uk
      FRONTSTAGE_SERVICE_PORT: '80'
      IAC_SERVICE_HOST: iac-service-concourse-preprod.apps.devtest.onsclofo.uk
      IAC_SERVICE_PORT: '80'
      IAC_URL: http://iac-service-concourse-preprod.apps.devtest.onsclofo.uk
      NOTIFY_GATEWAY_SERVICE_HOST: rm-notify-gateway-concourse-preprod.apps.devtest.onsclofo.uk
      NOTIFY_GATEWAY_SERVICE_PORT: '80'
      OAUTH_URL: http://django-oauth2-test-concourse-preprod.apps.devtest.onsclofo.uk
      PARTY_SERVICE_HOST: ras-party-concourse-preprod.apps.devtest.onsclofo.uk
      PARTY_SERVICE_PORT: '80'
      PARTY_URL: http://ras-party-concourse-preprod.apps.devtest.onsclofo.uk
      RM_CASE_SERVICE_HOST: rm-case-service-concourse-preprod.apps.devtest.onsclofo.uk
      RM_CASE_SERVICE_PORT: '80'
      RM_COLLECTION_EXERCISE_SERVICE_HOST: rm-collection-exercise-service-concourse-preprod.apps.devtest.onsclofo.uk
      RM_COLLECTION_EXERCISE_SERVICE_PORT: '80'
      RM_IAC_SERVICE_HOST: iac-service-concourse-preprod.apps.devtest.onsclofo.uk
      RM_IAC_SERVICE_PORT: '80'
      RM_SAMPLE_SERVICE_HOST: rm-sample-service-concourse-preprod.apps.devtest.onsclofo.uk
      RM_SAMPLE_SERVICE_PORT: '80'
      RM_SURVEY_SERVICE_HOST: rm-survey-service-concourse-preprod.apps.devtest.onsclofo.uk
      RM_SURVEY_SERVICE_PORT: '80'
      RAS_CASE_SERVICE_HOST: rm-case-service-concourse-preprod.apps.devtest.onsclofo.uk
      RAS_CASE_SERVICE_PORT: '80'
      RAS_COLLEX_SERVICE_HOST: rm-collection-exercise-service-concourse-preprod.apps.devtest.onsclofo.uk
      RAS_COLLEX_SERVICE_PORT: '80'
      RAS_IAC_SERVICE_HOST: iac-service-concourse-preprod.apps.devtest.onsclofo.uk
      RAS_IAC_SERVICE_PORT: '80'
      RAS_OAUTH_SERVICE_HOST: django-oauth2-test-concourse-preprod.apps.devtest.onsclofo.uk
      RAS_OAUTH_SERVICE_PORT: '80'
      RAS_PARTY_SERVICE_HOST: ras-party-concourse-preprod.apps.devtest.onsclofo.uk
      RAS_PARTY_SERVICE_PORT: '80'
      RAS_COLLECTION_INSTRUMENT_SERVICE_HOST: ras-collection-instrument-concourse-preprod.apps.devtest.onsclofo.uk
      RAS_COLLECTION_INSTRUMENT_SERVICE_PORT: '80'
      RAS_PUBLIC_WEBSITE_HOST: ras-frontstage-concourse-preprod.apps.devtest.onsclofo.uk
      RAS_PUBLIC_WEBSITE_PORT: '80'
      RAS_SECURE_MESSAGE_SERVICE_HOST: ras-secure-message-concourse-preprod.apps.devtest.onsclofo.uk
      RAS_SECURE_MESSAGE_SERVICE_PORT: '80'
      RAS_SECURE_MESSAGING_SERVICE_HOST: ras-secure-message-concourse-preprod.apps.devtest.onsclofo.uk
      RAS_SECURE_MESSAGING_SERVICE_PORT: '80'
      RAS_SURVEY_SERVICE_HOST: rm-survey-service-concourse-preprod.apps.devtest.onsclofo.uk
      RAS_SURVEY_SERVICE_PORT: '80'
      RESPONSE_OPERATIONS_UI_HOST: response-operations-ui-concourse-preprod.apps.devtest.onsclofo.uk
      RESPONSE_OPERATIONS_UI_PORT: '80'
      SAMPLE_SERVICE_HOST: rm-sample-service-concourse-preprod.apps.devtest.onsclofo.uk
      SAMPLE_SERVICE_PORT: '80'
      SAMPLE_URL: http://rm-sample-service-concourse-preprod.apps.devtest.onsclofo.uk
      SECURE_MESSAGE_SERVICE_HOST: ras-secure-message-concourse-preprod.apps.devtest.onsclofo.uk
      SECURE_MESSAGE_SERVICE_PORT: '80'
      SECURE_MESSAGE_URL: http://ras-secure-message-concourse-preprod.apps.devtest.onsclofo.uk
      SURVEY_SERVICE_HOST: rm-survey-service-concourse-preprod.apps.devtest.onsclofo.uk
      SURVEY_SERVICE_PORT: '80'
      SURVEY_URL: http://rm-survey-service-concourse-preprod.apps.devtest.onsclofo.uk
      UAA_SERVICE_URL: http://uaa-concourse-preprod.apps.devtest.onsclofo.uk

    service_endpoints_for_java: &preprod_service_endpoints_for_java
      actionSvc_connectionConfig_host: 'rm-action-service-concourse-preprod.apps.devtest.onsclofo.uk'
      actionSvc_connectionConfig_port: '80'
      actionSvc_connectionConfig_scheme: 'http'
      caseSvc_connectionConfig_host: 'rm-case-service-concourse-preprod.apps.devtest.onsclofo.uk'
      caseSvc_connectionConfig_port: '80'
      caseSvc_connectionConfig_scheme: 'http'
      collectionExerciseSvc_connectionConfig_host: 'rm-collection-exercise-service-concourse-preprod.apps.devtest.onsclofo.uk'
      collectionExerciseSvc_connectionConfig_port: '80'
      collectionExerciseSvc_connectionConfig_scheme: 'http'
      collectionInstrumentSvc_connectionConfig_host: 'ras-collection-instrument-concourse-preprod.apps.devtest.onsclofo.uk'
      collectionInstrumentSvc_connectionConfig_port: '80'
      collectionInstrumentSvc_connectionConfig_scheme: 'http'
      internetAccessCodeSvc_connectionConfig_host: 'iac-service-concourse-preprod.apps.devtest.onsclofo.uk'
      internetAccessCodeSvc_connectionConfig_port: '80'
      internetAccessCodeSvc_connectionConfig_scheme: 'http'
      partySvc_connectionConfig_host: 'ras-party-concourse-preprod.apps.devtest.onsclofo.uk'
      partySvc_connectionConfig_port: '80'
      partySvc_connectionConfig_scheme: 'http'
      sampleSvc_connectionConfig_host: 'rm-sample-service-concourse-preprod.apps.devtest.onsclofo.uk'
      sampleSvc_connectionConfig_port: '80'
      sampleSvc_connectionConfig_scheme: 'http'
      surveySvc_connectionConfig_host: 'rm-survey-service-concourse-preprod.apps.devtest.onsclofo.uk'
      surveySvc_connectionConfig_port: '80'
      surveySvc_connectionConfig_scheme: 'http'

    create_rm_redis: &preprod_create_rm_redis
      put: create-rm-redis
      resource: cf-cli-resource-preprod
      params:
        command: create-service
        service: elasticache-broker
        plan: small
        service_instance: rm-redis
        timeout: 1800
        wait_for_service: true

    create_rm_rabbitmq: &preprod_create_rm_rabbitmq
      put: create-rm-rabbitmq
      resource: cf-cli-resource-preprod
      params:
        command: create-service
        service: rabbitmq
        plan: standard
        service_instance: rm-rabbitmq
        timeout: 1800
        wait_for_service: true

    create_rm_pg_db: &preprod_create_rm_pg_db
      put: create-database
      resource: cf-cli-resource-preprod
      params:
        command: create-service
        service: rds
        plan: shared-psql
        service_instance: rm-pg-db
        timeout: 1800
        wait_for_service: true

  prod:
    security_user: &prod_security_user
      actionSvc_connectionConfig_password: ((prod_security_user_password))
      actionSvc_connectionConfig_username: ((prod_security_user_name))
      caseSvc_connectionConfig_username: ((prod_security_user_name))
      caseSvc_connectionConfig_password: ((prod_security_user_password))
      collectionExerciseSvc_connectionConfig_username: ((prod_security_user_name))
      collectionExerciseSvc_connectionConfig_password: ((prod_security_user_password))
      collectionInstrumentSvc_connectionConfig_username: ((prod_security_user_name))
      collectionInstrumentSvc_connectionConfig_password: ((prod_security_user_password))
      internetAccessCodeSvc_connectionConfig_password: ((prod_security_user_password))
      internetAccessCodeSvc_connectionConfig_username: ((prod_security_user_name))
      partySvc_connectionConfig_username: ((prod_security_user_name))
      partySvc_connectionConfig_password: ((prod_security_user_password))
      sampleSvc_connectionConfig_username: ((prod_security_user_name))
      sampleSvc_connectionConfig_password: ((prod_security_user_password))
      security_user_name: ((prod_security_user_name))
      security_user_password: ((prod_security_user_password))
      surveySvc_connectionConfig_username: ((prod_security_user_name))
      surveySvc_connectionConfig_password: ((prod_security_user_password))
      CASE_USERNAME: ((prod_security_user_name))
      CASE_PASSWORD: ((prod_security_user_password))
      COLLECTION_EXERCISE_USERNAME: ((prod_security_user_name))
      COLLECTION_EXERCISE_PASSWORD: ((prod_security_user_password))
      COLLECTION_INSTRUMENT_USERNAME: ((prod_security_user_name))
      COLLECTION_INSTRUMENT_PASSWORD: ((prod_security_user_password))
      IAC_USERNAME: ((prod_security_user_name))
      IAC_PASSWORD: ((prod_security_user_password))
      PARTY_USERNAME: ((prod_security_user_name))
      PARTY_PASSWORD: ((prod_security_user_password))
      SAMPLE_USERNAME: ((prod_security_user_name))
      SAMPLE_PASSWORD: ((prod_security_user_password))
      SECURITY_USER_NAME: ((prod_security_user_name))
      SECURITY_USER_PASSWORD: ((prod_security_user_password))
      SURVEY_USERNAME: ((prod_security_user_name))
      SURVEY_PASSWORD: ((prod_security_user_password))

    all_services: &prod_all_services
    - ras-party-prod-deploy
    - ras-backstage-prod-deploy
    - ras-frontstage-prod-deploy
    - django-oauth2-test-prod-deploy
    - response-operations-ui-prod-deploy
    - ras-secure-message-prod-deploy
    - ras-collection-instrument-prod-deploy
    - rm-action-service-prod-deploy
    - rm-actionexporter-service-prod-deploy
    - rm-case-service-prod-deploy
    - rm-collection-exercise-prod-deploy
    - iac-service-prod-deploy
    - rm-notify-gateway-prod-deploy
    - rm-sample-service-prod-deploy
    - rm-sdx-gateway-prod-deploy
    - rm-survey-service-prod-deploy
    - sdc-uaa-prod-deploy

    service_endpoints_for_python: &prod_service_endpoints_for_python
      ACCOUNT_SERVICE_URL: http://ras-frontstage-concourse-prod.apps.devtest.onsclofo.uk
      ACTION_SERVICE_HOST: rm-action-service-concourse-prod.apps.devtest.onsclofo.uk
      ACTION_SERVICE_PORT: '80'
      ACTION_EXPORTER_HOST: rm-actionexporter-service-concourse-prod.apps.devtest.onsclofo.uk
      ACTION_EXPORTER_PORT: '80'
      BACKSTAGE_API_URL: http://ras-backstage-concourse-prod.apps.devtest.onsclofo.uk/backstage-api
      BACKSTAGE_SERVICE_HOST: ras-backstage-concourse-prod.apps.devtest.onsclofo.uk
      BACKSTAGE_SERVICE_PORT: '80'
      CASE_SERVICE_HOST: rm-case-service-concourse-prod.apps.devtest.onsclofo.uk
      CASE_SERVICE_PORT: '80'
      CASE_URL: http://rm-case-service-concourse-prod.apps.devtest.onsclofo.uk
      COLLECTION_EXERCISE_SERVICE_HOST: rm-collection-exercise-service-concourse-prod.apps.devtest.onsclofo.uk
      COLLECTION_EXERCISE_SERVICE_PORT: '80'
      COLLECTION_EXERCISE_HOST: rm-collection-exercise-service-concourse-prod.apps.devtest.onsclofo.uk
      COLLECTION_EXERCISE_PORT: '80'
      COLLECTION_EXERCISE_URL: http://rm-collection-exercise-service-concourse-prod.apps.devtest.onsclofo.uk
      COLLECTION_INSTRUMENT_SERVICE_HOST: ras-collection-instrument-concourse-prod.apps.devtest.onsclofo.uk
      COLLECTION_INSTRUMENT_SERVICE_PORT: '80'
      COLLECTION_INSTRUMENT_URL: http://ras-collection-instrument-concourse-prod.apps.devtest.onsclofo.uk
      DJANGO_SERVICE_HOST: django-oauth2-test-concourse-prod.apps.devtest.onsclofo.uk
      DJANGO_SERVICE_PORT: '80'
      FRONTSTAGE_SERVICE_HOST: ras-frontstage-concourse-prod.apps.devtest.onsclofo.uk
      FRONTSTAGE_SERVICE_PORT: '80'
      IAC_SERVICE_HOST: iac-service-concourse-prod.apps.devtest.onsclofo.uk
      IAC_SERVICE_PORT: '80'
      IAC_URL: http://iac-service-concourse-prod.apps.devtest.onsclofo.uk
      NOTIFY_GATEWAY_SERVICE_HOST: rm-notify-gateway-concourse-prod.apps.devtest.onsclofo.uk
      NOTIFY_GATEWAY_SERVICE_PORT: '80'
      OAUTH_URL: http://django-oauth2-test-concourse-prod.apps.devtest.onsclofo.uk
      PARTY_SERVICE_HOST: ras-party-concourse-prod.apps.devtest.onsclofo.uk
      PARTY_SERVICE_PORT: '80'
      PARTY_URL: http://ras-party-concourse-prod.apps.devtest.onsclofo.uk
      RM_CASE_SERVICE_HOST: rm-case-service-concourse-prod.apps.devtest.onsclofo.uk
      RM_CASE_SERVICE_PORT: '80'
      RM_COLLECTION_EXERCISE_SERVICE_HOST: rm-collection-exercise-service-concourse-prod.apps.devtest.onsclofo.uk
      RM_COLLECTION_EXERCISE_SERVICE_PORT: '80'
      RM_IAC_SERVICE_HOST: iac-service-concourse-prod.apps.devtest.onsclofo.uk
      RM_IAC_SERVICE_PORT: '80'
      RM_SAMPLE_SERVICE_HOST: rm-sample-service-concourse-prod.apps.devtest.onsclofo.uk
      RM_SAMPLE_SERVICE_PORT: '80'
      RM_SURVEY_SERVICE_HOST: rm-survey-service-concourse-prod.apps.devtest.onsclofo.uk
      RM_SURVEY_SERVICE_PORT: '80'
      RAS_CASE_SERVICE_HOST: rm-case-service-concourse-prod.apps.devtest.onsclofo.uk
      RAS_CASE_SERVICE_PORT: '80'
      RAS_COLLEX_SERVICE_HOST: rm-collection-exercise-service-concourse-prod.apps.devtest.onsclofo.uk
      RAS_COLLEX_SERVICE_PORT: '80'
      RAS_IAC_SERVICE_HOST: iac-service-concourse-prod.apps.devtest.onsclofo.uk
      RAS_IAC_SERVICE_PORT: '80'
      RAS_OAUTH_SERVICE_HOST: django-oauth2-test-concourse-prod.apps.devtest.onsclofo.uk
      RAS_OAUTH_SERVICE_PORT: '80'
      RAS_PARTY_SERVICE_HOST: ras-party-concourse-prod.apps.devtest.onsclofo.uk
      RAS_PARTY_SERVICE_PORT: '80'
      RAS_COLLECTION_INSTRUMENT_SERVICE_HOST: ras-collection-instrument-concourse-prod.apps.devtest.onsclofo.uk
      RAS_COLLECTION_INSTRUMENT_SERVICE_PORT: '80'
      RAS_PUBLIC_WEBSITE_HOST: ras-frontstage-concourse-prod.apps.devtest.onsclofo.uk
      RAS_PUBLIC_WEBSITE_PORT: '80'
      RAS_SECURE_MESSAGE_SERVICE_HOST: ras-secure-message-concourse-prod.apps.devtest.onsclofo.uk
      RAS_SECURE_MESSAGE_SERVICE_PORT: '80'
      RAS_SECURE_MESSAGING_SERVICE_HOST: ras-secure-message-concourse-prod.apps.devtest.onsclofo.uk
      RAS_SECURE_MESSAGING_SERVICE_PORT: '80'
      RAS_SURVEY_SERVICE_HOST: rm-survey-service-concourse-prod.apps.devtest.onsclofo.uk
      RAS_SURVEY_SERVICE_PORT: '80'
      RESPONSE_OPERATIONS_UI_HOST: response-operations-ui-concourse-prod.apps.devtest.onsclofo.uk
      RESPONSE_OPERATIONS_UI_PORT: '80'
      SAMPLE_PORT: '80'
      SAMPLE_SERVICE_HOST: rm-sample-service-concourse-prod.apps.devtest.onsclofo.uk
      SAMPLE_SERVICE_PORT: '80'
      SAMPLE_URL: http://rm-sample-service-concourse-prod.apps.devtest.onsclofo.uk
      SECURE_MESSAGE_SERVICE_HOST: ras-secure-message-concourse-prod.apps.devtest.onsclofo.uk
      SECURE_MESSAGE_SERVICE_PORT: '80'
      SECURE_MESSAGE_URL: http://ras-secure-message-concourse-prod.apps.devtest.onsclofo.uk
      SURVEY_SERVICE_HOST: rm-survey-service-concourse-prod.apps.devtest.onsclofo.uk
      SURVEY_SERVICE_PORT: '80'
      SURVEY_URL: http://rm-survey-service-concourse-prod.apps.devtest.onsclofo.uk
      UAA_SERVICE_URL: http://uaa-concourse-prod.apps.devtest.onsclofo.uk

    service_endpoints_for_java: &prod_service_endpoints_for_java
      actionSvc_connectionConfig_host: 'rm-action-service-concourse-prod.apps.devtest.onsclofo.uk'
      actionSvc_connectionConfig_port: '80'
      actionSvc_connectionConfig_scheme: 'http'
      caseSvc_connectionConfig_host: 'rm-case-service-concourse-prod.apps.devtest.onsclofo.uk'
      caseSvc_connectionConfig_port: '80'
      caseSvc_connectionConfig_scheme: 'http'
      collectionExerciseSvc_connectionConfig_host: 'rm-collection-exercise-service-concourse-prod.apps.devtest.onsclofo.uk'
      collectionExerciseSvc_connectionConfig_port: '80'
      collectionExerciseSvc_connectionConfig_scheme: 'http'
      collectionInstrumentSvc_connectionConfig_host: 'ras-collection-instrument-concourse-prod.apps.devtest.onsclofo.uk'
      collectionInstrumentSvc_connectionConfig_port: '80'
      collectionInstrumentSvc_connectionConfig_scheme: 'http'
      internetAccessCodeSvc_connectionConfig_host: 'iac-service-concourse-prod.apps.devtest.onsclofo.uk'
      internetAccessCodeSvc_connectionConfig_port: '80'
      internetAccessCodeSvc_connectionConfig_scheme: 'http'
      partySvc_connectionConfig_host: 'ras-party-concourse-prod.apps.devtest.onsclofo.uk'
      partySvc_connectionConfig_port: '80'
      partySvc_connectionConfig_scheme: 'http'
      sampleSvc_connectionConfig_host: 'rm-sample-service-concourse-prod.apps.devtest.onsclofo.uk'
      sampleSvc_connectionConfig_port: '80'
      sampleSvc_connectionConfig_scheme: 'http'
      surveySvc_connectionConfig_host: 'rm-survey-service-concourse-prod.apps.devtest.onsclofo.uk'
      surveySvc_connectionConfig_port: '80'
      surveySvc_connectionConfig_scheme: 'http'

    create_rm_redis: &prod_create_rm_redis
      put: create-rm-redis
      resource: cf-cli-resource-prod
      params:
        command: create-service
        service: elasticache-broker
        plan: small
        service_instance: rm-redis
        timeout: 1800
        wait_for_service: true

    create_rm_rabbitmq: &prod_create_rm_rabbitmq
      put: create-rm-rabbitmq
      resource: cf-cli-resource-prod
      params:
        command: create-service
        service: rabbitmq
        plan: standard
        service_instance: rm-rabbitmq
        timeout: 1800
        wait_for_service: true

    create_rm_pg_db: &prod_create_rm_pg_db
      put: create-database
      resource: cf-cli-resource-prod
      params:
        command: create-service
        service: rds
        plan: shared-psql
        service_instance: rm-pg-db
        timeout: 1800
        wait_for_service: true

resource_types:
- name: cf-cli-resource
  type: docker-image
  source:
    repository: nulldriver/cf-cli-resource
    tag: latest

- name: slack-notification
  type: docker-image
  source:
    repository: cfcommunity/slack-notification-resource

### START MICROSERVICE REPOS
resources:
- name: ras-deploy
  type: git
  source:
    uri: https://github.com/ONSdigital/ras-deploy.git
    branch: master

- name: ras-party-source
  type: git
  source:
    uri: https://github.com/ONSdigital/ras-party.git
    branch: master

- name: ras-secure-message-source
  type: git
  source:
    uri: https://github.com/ONSdigital/ras-secure-message.git
    branch: master

- name: ras-backstage-source
  type: git
  source:
    uri: https://github.com/ONSdigital/ras-backstage.git
    branch: master

- name: ras-collection-instrument-source
  type: git
  source:
    uri: https://github.com/ONSdigital/ras-collection-instrument.git
    branch: master

- name: ras-frontstage-source
  type: git
  source:
    uri: https://github.com/ONSdigital/ras-frontstage.git
    branch: master

- name: django-oauth2-test-source
  type: git
  source:
    uri: https://github.com/ONSdigital/django-oauth2-test.git
    branch: master

- name: response-operations-ui-source
  type: git
  source:
    uri: https://github.com/ONSdigital/response-operations-ui.git

- name: rm-action-service-source
  type: git
  source:
    uri: https://github.com/ONSdigital/rm-action-service.git
    branch: master

- name: rm-actionexporter-service-source
  type: git
  source:
    uri: https://github.com/ONSdigital/rm-actionexporter-service.git
    branch: master

- name: rm-case-service-source
  type: git
  source:
    uri: https://github.com/ONSdigital/rm-case-service.git
    branch: master

- name: rm-collection-exercise-service-source
  type: git
  source:
    uri: https://github.com/ONSdigital/rm-collection-exercise-service.git
    branch: master

- name: iac-service-source
  type: git
  source:
    uri: git@github.com:ONSdigital/iac-service.git
    branch: master
    private_key: ((git_key))

- name: rm-notify-gateway-source
  type: git
  source:
    uri: https://github.com/ONSdigital/rm-notify-gateway.git
    branch: master

- name: rm-sample-service-source
  type: git
  source:
    uri: https://github.com/ONSdigital/rm-sample-service.git
    branch: master

- name: rm-sdx-gateway-source
  type: git
  source:
    uri: https://github.com/ONSdigital/rm-sdx-gateway.git
    branch: master

- name: rm-survey-service-source
  type: git
  source:
    uri: https://github.com/ONSdigital/rm-survey-service.git
    branch: master

- name: sdc-uaa-source
  type: git
  source:
    uri: https://github.com/ONSdigital/sdc-uaa.git
### END MICROSERVICE REPOS

- name: rasrm-acceptance-tests-source
  type: git
  source:
    uri: https://github.com/ONSdigital/rasrm-acceptance-tests.git
    branch: master

- name: cf-cli-resource-ci
  type: cf-cli-resource
  source:
    api: ((cloudfoundry_api))
    username: ((cloudfoundry_email))
    password: ((cloudfoundry_password))
    org: rmras
    space: ci
    skip_cert_check: true

- name: cf-resource-ci
  type: cf
  source:
    api: ((cloudfoundry_api))
    username: ((cloudfoundry_email))
    password: ((cloudfoundry_password))
    organization: rmras
    space: ci
    skip_cert_check: true

- name: ci-teardown-timer
  type: time
  source:
    start: 6AM

- name: cf-cli-resource-latest
  type: cf-cli-resource
  source:
    api: ((cloudfoundry_api))
    username: ((cloudfoundry_email))
    password: ((cloudfoundry_password))
    org: rmras
    space: concourse-latest
    skip_cert_check: true

- name: cf-resource-latest
  type: cf
  source:
    api: ((cloudfoundry_api))
    username: ((cloudfoundry_email))
    password: ((cloudfoundry_password))
    organization: rmras
    space: concourse-latest
    skip_cert_check: true

- name: notify
  type: slack-notification
  source:
    url: ((slack_webhook))

disabled-resources:
- name: preprod-deploy-trigger
  type: git
  source:
    uri: "git@github.com:ONSdigital/rasrm-deploy-trigger"
    paths: ["preprod/*"]
    private_key: ((git_key))

- name: prod-deploy-trigger
  type: git
  source:
    uri: "git@github.com:ONSdigital/rasrm-deploy-trigger"
    paths: ["prod/*"]
    private_key: ((git_key))

- name: cf-cli-resource-preprod
  type: cf-cli-resource
  source:
    api: ((cloudfoundry_api))
    username: ((cloudfoundry_email))
    password: ((cloudfoundry_password))
    org: rmras
    space: concourse-preprod
    skip_cert_check: true

- name: cf-resource-preprod
  type: cf
  source:
    api: ((cloudfoundry_api))
    username: ((cloudfoundry_email))
    password: ((cloudfoundry_password))
    organization: rmras
    space: concourse-preprod
    skip_cert_check: true

- name: cf-cli-resource-prod
  type: cf-cli-resource
  source:
    api: ((cloudfoundry_api))
    username: ((cloudfoundry_email))
    password: ((cloudfoundry_password))
    org: rmras
    space: concourse-prod
    skip_cert_check: true

- name: cf-resource-prod
  type: cf
  source:
    api: ((cloudfoundry_api))
    username: ((cloudfoundry_email))
    password: ((cloudfoundry_password))
    organization: rmras
    space: concourse-prod
    skip_cert_check: true

jobs:
- name: ci-teardown
  serial_groups: *ci_all_services
  plan:
  - get: ras-deploy
  - get: ci-teardown-timer
    trigger: true
  - task: clear-space
    file: ras-deploy/tasks/clear_space.yml
    params:
      CLOUDFOUNDRY_API: ((cloudfoundry_api))
      CLOUDFOUNDRY_EMAIL: ((cloudfoundry_email))
      CLOUDFOUNDRY_PASSWORD: ((cloudfoundry_password))
      CLOUDFOUNDRY_ORG: rmras
      CLOUDFOUNDRY_SPACE: ci

### START DEPLOYMENTS
- name: ras-party-ci-deploy
  serial_groups: [ras-party-ci-deploy]
  plan:
  - get: ras-party-source
    trigger: true
  - get: ci-teardown-timer
    trigger: true
    passed: [ci-teardown]
  - put: create-database
    resource: cf-cli-resource-ci
    params:
      command: create-service
      service: rds
      plan: shared-psql
      service_instance: ras-party-db
      timeout: 300
      wait_for_service: true
  - put: push-app
    resource: cf-resource-ci
    params:
      current_app_name: ras-party-ci
      manifest: ras-party-source/manifest.yml
      path: ras-party-source
      environment_variables:
        <<: *ci_security_user
        <<: *ci_service_endpoints_for_python
        RAS_NOTIFY_CONFIRM_PASSWORD_CHANGE_TEMPLATE: ba41c152-ad96-4255-9456-9e42de83f510
        RAS_NOTIFY_EMAIL_VERIFICATION_TEMPLATE: 53c59576-8c3b-4298-99d1-b245ddd28500
        RAS_NOTIFY_REQUEST_PASSWORD_CHANGE_TEMPLATE: c45c59ff-7771-4de4-a66b-ce50b108390a
        RAS_NOTIFY_SERVICE_URL: http://rm-notify-gateway-ci.apps.devtest.onsclofo.uk/emails/

- name: ras-secure-message-ci-deploy
  serial_groups: [ras-secure-message-ci-deploy]
  plan:
  - get: ras-secure-message-source
    trigger: true
  - get: ci-teardown-timer
    trigger: true
    passed: [ci-teardown]
  - put: create-database
    resource: cf-cli-resource-ci
    params:
      command: create-service
      service: rds
      plan: shared-psql
      service_instance: secure-message-db
      timeout: 300
      wait_for_service: true
  - put: cf-resource-ci
    params:
      current_app_name: ras-secure-message-ci
      manifest: ras-secure-message-source/manifest.yml
      path: ras-secure-message-source
      environment_variables:
        <<: *ci_security_user
        <<: *ci_service_endpoints_for_python
        JWT_ALGORITHM: 'HS256'
        JWT_SECRET: ((ci_jwt_secret))
        NOTIFICATION_API_KEY: ((test_notify_api_key))
        NOTIFICATION_TEMPLATE_ID: 'f6404844-a994-428c-a5d7-45a4e1cfff4b'
        NOTIFY_VIA_GOV_NOTIFY: '1'
        RM_NOTIFY_GATEWAY_URL: 'http://rm-notify-gateway-ci.apps.devtest.onsclofo.uk/emails/'
        RAS_SM_PATH: '/home/vcap/app'
        SERVICE_ID: 'ce3674b1-7b08-4377-a6a7-05b5722d4ea5'
        UAA_URL: 'http://uaa-ci.apps.devtest.onsclofo.uk'
        CLIENT_ID: 'secure_message'
        CLIENT_SECRET: ((ci_secure_message_client_secret))
        USE_UAA: '1'

- name: ras-backstage-ci-deploy
  serial_groups: [ras-backstage-ci-deploy]
  plan:
  - get: ras-backstage-source
    trigger: true
  - get: ci-teardown-timer
    trigger: true
    passed: [ci-teardown]
  - put: cf-resource-ci
    params:
      current_app_name: ras-backstage-ci
      manifest: ras-backstage-source/manifest.yml
      path: ras-backstage-source
      environment_variables:
        <<: *ci_security_user
        <<: *ci_service_endpoints_for_python
        RAS_SECURE_MESSAGING_JWT_SECRET: ((ci_jwt_secret))
        UAA_CLIENT_ID: 'response_operations'
        UAA_CLIENT_SECRET: ((ci_response_operations_client_secret))
        UAA_SERVICE_URL: 'http://uaa-ci.apps.devtest.onsclofo.uk'
        USE_UAA: '1'

- name: ras-collection-instrument-ci-deploy
  serial_groups: [ras-collection-instrument-ci-deploy]
  plan:
  - get: ras-collection-instrument-source
    trigger: true
  - get: ras-deploy
  - get: ci-teardown-timer
    trigger: true
    passed: [ci-teardown]
  - put: create-sdx-rabbitmq
    resource: cf-cli-resource-ci
    params:
      command: create-service
      service: rabbitmq
      plan: standard
      service_instance: sdx-rabbitmq
      timeout: 1800
      wait_for_service: true
  - put: create-rm-rabbitmq
    resource: cf-cli-resource-ci
    params:
      command: create-service
      service: rabbitmq
      plan: standard
      service_instance: rm-rabbitmq
      timeout: 1800
      wait_for_service: true
  - put: create-database
    resource: cf-cli-resource-ci
    params:
      command: create-service
      service: rds
      plan: shared-psql
      service_instance: ras-ci-db
      timeout: 300
      wait_for_service: true
  - put: cf-resource-ci
    params:
      current_app_name: ras-collection-instrument-ci
      manifest: ras-collection-instrument-source/manifest-ci.yml
      path: ras-collection-instrument-source
      environment_variables:
        <<: *ci_security_user
        <<: *ci_service_endpoints_for_python
        JSON_SECRET_KEYS: ((ci_json_secret_keys))
        ONS_CRYPTOKEY: ((ci_collection_instrument_encryption_key))
        RABBITMQ_AMQP_COLLECTION_INSTRUMENT: ((ci_rabbitmq_amqp_collection_instrument)) # What is this queue?
        RABBITMQ_AMQP_SURVEY_RESPONSE: ((ci_rabbitmq_amqp_survey_response))

- name: ras-frontstage-ci-deploy
  serial_groups: [ras-frontstage-ci-deploy]
  plan:
  - get: ras-frontstage-source
    trigger: true
  - get: ci-teardown-timer
    trigger: true
    passed: [ci-teardown]
  - <<: *ci_create_rm_redis
  - put: cf-resource-ci
    params:
      current_app_name: ras-frontstage-ci
      manifest: ras-frontstage-source/manifest.yml
      path: ras-frontstage-source
      environment_variables:
        <<: *ci_security_user
        <<: *ci_service_endpoints_for_python
        EQ_URL: 'https://eq-test/session?token='
        JSON_SECRET_KEYS: ((ci_json_secret_keys))
        JWT_SECRET: ((ci_jwt_secret))
        OAUTH_CLIENT_ID: 'ons@ons.gov'
        OAUTH_CLIENT_SECRET: 'password'
        SECRET_KEY: ((ci_enrolement_code_encryption_key))

- name: django-oauth2-test-ci-deploy
  serial_groups: [django-oauth2-test-ci-deploy]
  plan:
  - get: django-oauth2-test-source
    trigger: true
  - get: ras-deploy
  - get: ci-teardown-timer
    trigger: true
    passed: [ci-teardown]
  - put: create-database
    resource: cf-cli-resource-ci
    params:
      command: create-service
      service: rds
      plan: shared-psql
      service_instance: oauth-db
      timeout: 300
      wait_for_service: true
  # Create git_info file for info end point
  - task: git-info
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: paasmule/curl-ssl-git
          tag: "latest"
      inputs:
        - name: django-oauth2-test-source
      outputs:
        - name: django-oauth2-test-source-git-info
      run:
        path: sh
        args:
        - -exc
        - |
          cd django-oauth2-test-source
          branch=$(git rev-parse --abbrev-ref HEAD)
          url=$(git config --get remote.origin.url)
          commit=$(git rev-parse HEAD)
          repo=$(basename `git rev-parse --show-toplevel`)
          when=`date --utc +%FT%TZ`
          output=git_info
          echo '{' > ${output}
          echo   \"origin\": \"${url}\", >> ${output}
          echo   \"commit\": \"${commit}\", >> ${output}
          echo   \"branch\": \"${branch}\", >> ${output}
          echo   \"name\": \"${repo}\", >> ${output}
          echo   \"built\": \"${when}\" >> ${output}
          echo '}' >> ${output}
          cd ..
          cp -r django-oauth2-test-source/* django-oauth2-test-source-git-info
  - put: cf-resource-ci
    params:
      current_app_name: django-oauth2-test-ci
      manifest: django-oauth2-test-source-git-info/manifest.yml
      path: django-oauth2-test-source-git-info
      environment_variables:
        <<: *ci_security_user
        CSRF_ENABLED: 'True'
        DEBUG: 'False'
        DJANGO_SETTINGS_MODULE: 'proj.settings.cloud_foundry_settings'
        OAUTH2_SUPER_USER: ((ci_oauth2_super_user))
        OAUTH2_SUPER_USER_EMAIL: ((ci_oauth2_super_user_email))
        OAUTH2_SUPER_USER_PASSWORD: ((ci_oauth2_super_user_password))
        SECRET_KEY: ((ci_jwt_secret))
        TESTING: 'False'
  - task: create-super-user
    file: ras-deploy/tasks/django-oauth2-test/create_default_user.yml
    params:
      CLOUDFOUNDRY_API: ((cloudfoundry_api))
      CLOUDFOUNDRY_EMAIL: ((cloudfoundry_email))
      CLOUDFOUNDRY_PASSWORD: ((cloudfoundry_password))
      CLOUDFOUNDRY_ORG: rmras
      CLOUDFOUNDRY_SPACE: ci
      APP_NAME: django-oauth2-test-ci

- name: response-operations-ui-ci-deploy
  serial_groups: [response-operations-ui-ci-deploy]
  plan:
  - get: response-operations-ui-source
    trigger: true
  - get: ci-teardown-timer
    trigger: true
    passed: [ci-teardown]
  - put: create-redis
    resource: cf-cli-resource-ci
    params:
      command: create-service
      service: elasticache-broker
      plan: small
      service_instance: ras-redis
      timeout: 1800
      wait_for_service: true
  - put: cf-resource-ci
    params:
      current_app_name: response-operations-ui-ci
      manifest: response-operations-ui-source/manifest.yml
      path: response-operations-ui-source
      environment_variables:
        <<: *ci_security_user
        <<: *ci_service_endpoints_for_python
        RAS_SECURE_MESSAGING_JWT_SECRET: ((ci_jwt_secret))
        REDIS_SERVICE: ras-redis
        UAA_CLIENT_ID: 'response_operations'
        UAA_CLIENT_SECRET: ((ci_response_operations_client_secret))

- name: rm-action-service-ci-deploy
  serial_groups: [rm-action-service-ci-deploy]
  plan:
  - get: rm-action-service-source
    trigger: true
  - get: ci-teardown-timer
    trigger: true
    passed: [ci-teardown]
  - aggregate:
    - <<: *ci_create_rm_pg_db
    - <<: *ci_create_rm_redis
    - <<: *ci_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-action-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-action-service-source/.maven.settings.xml install -Ddockerfile.skip -f rm-action-service-source/pom.xml
            cp -r rm-action-service-source/target/ .
  - put: cf-resource-ci
    params:
      current_app_name: rm-action-service-ci
      manifest: rm-action-service-source/manifest-no-envs.yml
      path: target/actionsvc*.jar
      environment_variables:
        <<: *ci_security_user
        <<: *ci_service_endpoints_for_java
        endpoints_enabled: 'false'

- name: rm-actionexporter-service-ci-deploy
  serial_groups: [rm-actionexporter-service-ci-deploy]
  plan:
  - get: rm-actionexporter-service-source
    trigger: true
  - get: ci-teardown-timer
    trigger: true
    passed: [ci-teardown]
  - aggregate:
    - <<: *ci_create_rm_pg_db
    - <<: *ci_create_rm_redis
    - <<: *ci_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-actionexporter-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-actionexporter-service-source/.maven.settings.xml install -Ddockerfile.skip -f rm-actionexporter-service-source/pom.xml
            cp -r rm-actionexporter-service-source/target/ .
  - put: cf-resource-ci
    params:
      current_app_name: rm-actionexporter-service-ci
      manifest: rm-actionexporter-service-source/manifest.yml
      path: target/actionexportersvc*.jar
      environment_variables:
        <<: *ci_security_user
        endpoints_enabled: 'false'
        exportSchedule_cronExpression: '0 * * * * ?'
        sftp_host: ((sftp_host))
        sftp_password: ((actionexporter_sftp_password))
        sftp_port: '22'
        sftp_username: ((actionexporter_sftp_username))

- name: rm-case-service-ci-deploy
  serial_groups: [rm-case-service-ci-deploy]
  plan:
  - get: rm-case-service-source
    trigger: true
  - get: ci-teardown-timer
    trigger: true
    passed: [ci-teardown]
  - aggregate:
    - <<: *ci_create_rm_pg_db
    - <<: *ci_create_rm_redis
    - <<: *ci_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-case-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-case-service-source/.maven.settings.xml install -Ddockerfile.skip -f rm-case-service-source/pom.xml
            cp -r rm-case-service-source/target/ .
  - put: cf-resource-ci
    params:
      current_app_name: rm-case-service-ci
      manifest: rm-case-service-source/manifest-no-envs.yml
      path: target/casesvc*.jar
      environment_variables:
        <<: *ci_security_user
        <<: *ci_service_endpoints_for_java
        endpoints_enabled: 'false'

- name: rm-collection-exercise-ci-deploy
  serial_groups: [rm-collection-exercise-ci-deploy]
  plan:
  - get: rm-collection-exercise-service-source
    trigger: true
  - get: ci-teardown-timer
    trigger: true
    passed: [ci-teardown]
  - aggregate:
    - <<: *ci_create_rm_pg_db
    - <<: *ci_create_rm_redis
    - <<: *ci_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-collection-exercise-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-collection-exercise-service-source/.maven.settings.xml install -Ddockerfile.skip -Ddocker.skip -DskipITs -f rm-collection-exercise-service-source/pom.xml
            cp -r rm-collection-exercise-service-source/target/ .
  - put: cf-resource-ci
    params:
      current_app_name: rm-collection-exercise-service-ci
      manifest: rm-collection-exercise-service-source/manifest-no-envs.yml
      path: target/collectionexercisesvc*.jar
      environment_variables:
        <<: *ci_security_user
        <<: *ci_service_endpoints_for_java
        endpoints_enabled: 'false'
        SCHEDULES_VALIDATION_SCHEDULE_DELAY_MILLI_SECONDS: '1000'
        SCHEDULES_DISTRIBUTION_SCHEDULE_DELAY_MILLI_SECONDS: '1000'

- name: iac-service-ci-deploy
  serial_groups: [iac-service-ci-deploy]
  plan:
  - get: iac-service-source
    trigger: true
  - get: ci-teardown-timer
    trigger: true
    passed: [ci-teardown]
  - aggregate:
    - <<: *ci_create_rm_pg_db
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: iac-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings iac-service-source/.maven.settings.xml install -Ddockerfile.skip -f iac-service-source/pom.xml
            cp -r iac-service-source/target/ .
  - put: cf-resource-ci
    params:
      current_app_name: iac-service-ci
      manifest: iac-service-source/manifest-no-envs.yml
      path: target/iacsvc*.jar
      environment_variables:
        <<: *ci_security_user
        <<: *ci_service_endpoints_for_java
        endpoints_enabled: 'false'

- name: rm-notify-gateway-ci-deploy
  serial_groups: [rm-notify-gateway-ci-deploy]
  plan:
  - get: rm-notify-gateway-source
    trigger: true
  - get: ci-teardown-timer
    trigger: true
    passed: [ci-teardown]
  - aggregate:
    - <<: *ci_create_rm_pg_db
    - <<: *ci_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-notify-gateway-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-notify-gateway-source/.maven.settings.xml install -Ddockerfile.skip -f rm-notify-gateway-source/pom.xml
            cp -r rm-notify-gateway-source/target/ .
  - put: cf-resource-ci
    params:
      current_app_name: rm-notify-gateway-ci
      manifest: rm-notify-gateway-source/manifest.yml
      path: target/notifygatewaysvc*.jar
      environment_variables:
        <<: *ci_security_user
        endpoints_enabled: 'false'
        notify_apiKey: ((test_notify_api_key))
        notify_censusUacSmsTemplateId: '966731dc-ef2e-41ad-a828-8cdd95c81ebc'
        notify_enabled: 'false'
        notify_onsSurveysRasEmailReminderTemplateId: '19a0aa89-797f-4a34-ad54-267fd581f2ef'

- name: rm-sample-service-ci-deploy
  serial_groups: [rm-sample-service-ci-deploy]
  plan:
  - get: rm-sample-service-source
    trigger: true
  - get: ci-teardown-timer
    trigger: true
    passed: [ci-teardown]
  - aggregate:
    - <<: *ci_create_rm_pg_db
    - <<: *ci_create_rm_redis
    - <<: *ci_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-sample-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-sample-service-source/.maven.settings.xml install -Ddockerfile.skip -Ddocker.skip -DskipITs -f rm-sample-service-source/pom.xml
            cp -r rm-sample-service-source/target/ .
  - put: cf-resource-ci
    params:
      current_app_name: rm-sample-service-ci
      manifest: rm-sample-service-source/manifest-no-envs.yml
      path: target/samplesvc*.jar
      environment_variables:
        <<: *ci_security_user
        <<: *ci_service_endpoints_for_java
        SAMPLE_UNIT_DISTRIBUTION_DELAY_MILLI_SECONDS: '1000'
        endpoints_enabled: 'false'
        exportSchedule_cronExpression: '0 0/5 * * * ?'
        sftp_host: ((sftp_host))
        sftp_password: ((sample_sftp_password))
        sftp_port: '22'
        sftp_username: ((sample_sftp_username))

- name: rm-sdx-gateway-ci-deploy
  serial_groups: [rm-sdx-gateway-ci-deploy]
  plan:
  - get: rm-sdx-gateway-source
    trigger: true
  - get: ci-teardown-timer
    trigger: true
    passed: [ci-teardown]
  - aggregate:
    - <<: *ci_create_rm_redis
    - <<: *ci_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-sdx-gateway-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-sdx-gateway-source/.maven.settings.xml install -Ddockerfile.skip -f rm-sdx-gateway-source/pom.xml
            cp -r rm-sdx-gateway-source/target/ .
  - put: cf-resource-ci
    params:
      current_app_name: rm-sdx-gateway-ci
      manifest: rm-sdx-gateway-source/manifest.yml
      path: target/sdxgatewaysvc*.jar
      environment_variables:
        <<: *ci_security_user
        endpoints_enabled: 'false'

- name: rm-survey-service-ci-deploy
  serial_groups: [rm-survey-service-ci-deploy]
  plan:
  - get: rm-survey-service-source
    trigger: true
  - get: ci-teardown-timer
    trigger: true
    passed: [ci-teardown]
  - aggregate:
    - <<: *ci_create_rm_pg_db
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: golang
        inputs:
          - name: rm-survey-service-source
        outputs:
          - name: rm-survey-service-build
            path: rm-survey-service
        run:
          path: sh
          args:
          - -exc
          - |
            mkdir -p /go/src/github.com/ONSdigital/
            cp -r rm-survey-service-source /go/src/github.com/ONSdigital/rm-survey-service
            make -C /go/src/github.com/ONSdigital/rm-survey-service
            cp -r /go/src/github.com/ONSdigital/rm-survey-service/ .
  - put: cf-resource-ci
    params:
      current_app_name: rm-survey-service-ci
      manifest: rm-survey-service-source/manifest.yml
      path: rm-survey-service-build
      environment_variables:
        <<: *ci_security_user
        MIGRATION_SOURCE: 'file://db-migrations'

- name: sdc-uaa-ci-deploy
  serial_groups: [sdc-uaa-ci-deploy]
  plan:
  - get: sdc-uaa-source
    trigger: true
  - get: ci-teardown-timer
    trigger: true
    passed: [ci-teardown]
  - task: build
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: sdcplatform/maven-cf-cli-docker
      inputs:
        - name: sdc-uaa-source
      outputs:
        - name: sdc-uaa-build
          path: sdc-uaa-build
      params:
        UAA_PRIVATE_KEY: ((ci_uaa_private_key))
        UAA_CERTIFICATE: ((ci_uaa_certificate))
        UAA_PRIVATE_KEY_PASSWORD: ((ci_uaa_private_key_password))
        JENKINS_CF_USERNAME: ((cloudfoundry_email))
        JENKINS_CF_PASSWORD: ((cloudfoundry_password))
        API_ENDPOINT: ((cloudfoundry_api))
        ORG: rmras
        SPACE: ci
        UAA_ID: ((ci_uaa_id))
        UAA_SECRET: ((ci_uaa_secret))
        UAA_JWT_SIGNING_KEY: ((ci_uaa_jwt_signing_key))
        UAA_JWT_VERIFICATION_KEY: ((ci_uaa_jwt_verification_key))
        UAA_URL: 'http://uaa-ci.apps.devtest.onsclofo.uk'
        LOGIN_URL: 'http://uaa-ci.apps.devtest.onsclofo.uk'
        ZONE_URL: 'uaa-ci.apps.devtest.onsclofo.uk'
        ADMIN_SECRET: ((ci_uaa_admin_secret))
        LOGIN_SECRET: ((ci_uaa_login_secret))
      run:
        path: sh
        args:
        - -exc
        - |
          (cd sdc-uaa-source && ls && sh deploy-uaa-pre-steps.sh dev)
          mvn install -f sdc-uaa-source/pom.xml
          cp -r sdc-uaa-source/* sdc-uaa-build
  - put: cf-resource-ci
    params:
      current_app_name: sdc-uaa-ci
      manifest: sdc-uaa-build/uaa-cf-application.yml
      #### EXTRACT ME ####
  - task: create-secure-message-client
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: kennethreitz/pipenv
      inputs:
        - name: sdc-uaa-source
      params:
        SPACE: ci
        CLIENT: secure_message
        PASSWORD: ((ci_secure_message_client_secret))
        ADMIN_SECRET: ((ci_uaa_admin_secret))
        UAA_URL: 'uaa-ci.apps.devtest.onsclofo.uk'
      run:
        dir: sdc-uaa-source
        path: sh
        args:
        - './scripts/jenkins/add_client.sh'
  - task: create-response_operations-client
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: kennethreitz/pipenv
      inputs:
        - name: sdc-uaa-source
      params:
        SPACE: ci
        CLIENT: response_operations
        PASSWORD: ((ci_response_operations_client_secret))
        ADMIN_SECRET: ((ci_uaa_admin_secret))
        UAA_URL: 'uaa-ci.apps.devtest.onsclofo.uk'
      run:
        dir: sdc-uaa-source
        path: sh
        args:
        - './scripts/jenkins/add_client.sh'
  - task: create-uaa-user
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: kennethreitz/pipenv
      inputs:
        - name: sdc-uaa-source
      params:
        SPACE: ci
        USERNAME: uaa_user
        PASSWORD: ((ci_uaa_user_password))
        EMAIL: ons@ons.gov
        FIRSTNAME: uaa
        LASTNAME: user
        ADMIN_SECRET: ((ci_uaa_admin_secret))
        UAA_URL: 'uaa-ci.apps.devtest.onsclofo.uk'
      run:
        dir: sdc-uaa-source
        path: sh
        args:
        - './scripts/jenkins/add_user.sh'
### END CI DEPLOYMENTS

- name: ci-rasrm-acceptance-tests
  serial_groups: *ci_all_services
  plan:
  - get: ras-deploy
  - get: ci-teardown-timer
    trigger: true
    passed: *ci_all_services
  - get: rasrm-acceptance-tests-source
    trigger: true
  - get: ras-party-source
    passed: [ras-party-ci-deploy]
    trigger: true
  - get: ras-backstage-source
    passed: [ras-backstage-ci-deploy]
    trigger: true
  - get: ras-frontstage-source
    passed: [ras-frontstage-ci-deploy]
    trigger: true
  - get: django-oauth2-test-source
    passed: [django-oauth2-test-ci-deploy]
    trigger: true
  - get: response-operations-ui-source
    passed: [response-operations-ui-ci-deploy]
    trigger: true
  - get: ras-secure-message-source
    passed: [ras-secure-message-ci-deploy]
    trigger: true
  - get: ras-collection-instrument-source
    passed: [ras-collection-instrument-ci-deploy]
    trigger: true
  - get: rm-action-service-source
    passed: [rm-action-service-ci-deploy]
    trigger: true
  - get: rm-actionexporter-service-source
    passed: [rm-actionexporter-service-ci-deploy]
    trigger: true
  - get: rm-case-service-source
    passed: [rm-case-service-ci-deploy]
    trigger: true
  - get: rm-collection-exercise-service-source
    passed: [rm-collection-exercise-ci-deploy]
    trigger: true
  - get: iac-service-source
    passed: [iac-service-ci-deploy]
    trigger: true
  - get: rm-notify-gateway-source
    passed: [rm-notify-gateway-ci-deploy]
    trigger: true
  - get: rm-sample-service-source
    passed: [rm-sample-service-ci-deploy]
    trigger: true
  - get: rm-sdx-gateway-source
    passed: [rm-sdx-gateway-ci-deploy]
    trigger: true
  - get: rm-survey-service-source
    passed: [rm-survey-service-ci-deploy]
    trigger: true
  - get: sdc-uaa-source
    passed: [sdc-uaa-ci-deploy]
    trigger: true
  - task: get-cf-database-uris
    file: ras-deploy/tasks/get_database_uris.yml
    params:
      CLOUDFOUNDRY_API: ((cloudfoundry_api))
      CLOUDFOUNDRY_EMAIL: ((cloudfoundry_email))
      CLOUDFOUNDRY_PASSWORD: ((cloudfoundry_password))
      CLOUDFOUNDRY_ORG: rmras
      CLOUDFOUNDRY_SPACE: ci
  - task: acceptance-test-setup
    on_failure:
      put: notify
      params:
        text: "Acceptance tests setup failed in CI space"
    privileged: true
    file: ras-deploy/tasks/rasrm-acceptance-tests/run_acceptance_tests.yml
    params:
      <<: *ci_security_user
      <<: *ci_service_endpoints_for_python
      MAKE_TARGET: setup
  - task: rasrm-acceptance-tests
    on_failure:
      put: notify
      params:
        text: "RASRM acceptance tests failed in CI space"
    privileged: true
    file: ras-deploy/tasks/rasrm-acceptance-tests/run_acceptance_tests.yml
    params:
      <<: *ci_security_user
      <<: *ci_service_endpoints_for_python
      MAKE_TARGET: rasrm_acceptance_tests

- name: ci-securemessage-acceptance-tests
  serial_groups:
    *ci_all_services
  plan:
  - get: ras-deploy
  - get: ci-teardown-timer
    trigger: true
    passed: *ci_all_services
  - get: rasrm-acceptance-tests-source
    trigger: true
  - get: ras-party-source
    passed: [ras-party-ci-deploy]
    trigger: true
  - get: ras-backstage-source
    passed: [ras-backstage-ci-deploy]
    trigger: true
  - get: ras-frontstage-source
    passed: [ras-frontstage-ci-deploy]
    trigger: true
  - get: django-oauth2-test-source
    passed: [django-oauth2-test-ci-deploy]
    trigger: true
  - get: response-operations-ui-source
    passed: [response-operations-ui-ci-deploy]
    trigger: true
  - get: ras-secure-message-source
    passed: [ras-secure-message-ci-deploy]
    trigger: true
  - get: ras-collection-instrument-source
    passed: [ras-collection-instrument-ci-deploy]
    trigger: true
  - get: rm-action-service-source
    passed: [rm-action-service-ci-deploy]
    trigger: true
  - get: rm-actionexporter-service-source
    passed: [rm-actionexporter-service-ci-deploy]
    trigger: true
  - get: rm-case-service-source
    passed: [rm-case-service-ci-deploy]
    trigger: true
  - get: rm-collection-exercise-service-source
    passed: [rm-collection-exercise-ci-deploy]
    trigger: true
  - get: iac-service-source
    passed: [iac-service-ci-deploy]
    trigger: true
  - get: rm-notify-gateway-source
    passed: [rm-notify-gateway-ci-deploy]
    trigger: true
  - get: rm-sample-service-source
    passed: [rm-sample-service-ci-deploy]
    trigger: true
  - get: rm-sdx-gateway-source
    passed: [rm-sdx-gateway-ci-deploy]
    trigger: true
  - get: rm-survey-service-source
    passed: [rm-survey-service-ci-deploy]
    trigger: true
  - get: sdc-uaa-source
    passed: [sdc-uaa-ci-deploy]
    trigger: true
  - task: get-cf-database-uris
    file: ras-deploy/tasks/get_database_uris.yml
    params:
      CLOUDFOUNDRY_API: ((cloudfoundry_api))
      CLOUDFOUNDRY_EMAIL: ((cloudfoundry_email))
      CLOUDFOUNDRY_PASSWORD: ((cloudfoundry_password))
      CLOUDFOUNDRY_ORG: rmras
      CLOUDFOUNDRY_SPACE: ci
  - task: acceptance-test-setup
    on_failure:
      put: notify
      params:
        text: "Acceptance tests setup failed in CI space"
    privileged: true
    file: ras-deploy/tasks/rasrm-acceptance-tests/run_acceptance_tests.yml
    params:
      <<: *ci_security_user
      <<: *ci_service_endpoints_for_python
      MAKE_TARGET: setup
  - task: secure-messaging-acceptance-tests
    on_failure:
      put: notify
      params:
        text: "Secure Messaging acceptance tests failed in CI space"
    privileged: true
    file: ras-deploy/tasks/rasrm-acceptance-tests/run_acceptance_tests.yml
    params:
      <<: *ci_security_user
      <<: *ci_service_endpoints_for_python
      MAKE_TARGET: secure_messaging_acceptance_tests


### START latest SPACE DEPLOYMENTS
- name: ras-party-latest-deploy
  serial_groups: [ras-party-latest-deploy]
  plan:
  - get: ras-party-source
    trigger: true
    passed: [ci-rasrm-acceptance-tests, ci-securemessage-acceptance-tests]
  - put: create-database
    resource: cf-cli-resource-latest
    params:
      command: create-service
      service: rds
      plan: shared-psql
      service_instance: ras-party-db
      timeout: 300
      wait_for_service: true
  - put: push-app
    resource: cf-resource-latest
    params:
      current_app_name: ras-party-concourse-latest
      manifest: ras-party-source/manifest.yml
      path: ras-party-source
      environment_variables:
        <<: *latest_security_user
        <<: *latest_service_endpoints_for_python
        RAS_NOTIFY_CONFIRM_PASSWORD_CHANGE_TEMPLATE: ba41c152-ad96-4255-9456-9e42de83f510
        RAS_NOTIFY_EMAIL_VERIFICATION_TEMPLATE: 53c59576-8c3b-4298-99d1-b245ddd28500
        RAS_NOTIFY_REQUEST_PASSWORD_CHANGE_TEMPLATE: c45c59ff-7771-4de4-a66b-ce50b108390a
        RAS_NOTIFY_SERVICE_URL: http://rm-notify-gateway-concourse-latest.apps.devtest.onsclofo.uk/emails/

- name: ras-secure-message-latest-deploy
  serial_groups: [ras-secure-message-latest-deploy]
  plan:
  - get: ras-secure-message-source
    trigger: true
    passed: [ci-rasrm-acceptance-tests, ci-securemessage-acceptance-tests]
  - put: create-database
    resource: cf-cli-resource-latest
    params:
      command: create-service
      service: rds
      plan: shared-psql
      service_instance: secure-message-db
      timeout: 300
      wait_for_service: true
  - put: cf-resource-latest
    params:
      current_app_name: ras-secure-message-concourse-latest
      manifest: ras-secure-message-source/manifest.yml
      path: ras-secure-message-source
      environment_variables:
        <<: *latest_security_user
        <<: *latest_service_endpoints_for_python
        JWT_ALGORITHM: 'HS256'
        JWT_SECRET: ((latest_jwt_secret))
        NOTIFICATION_API_KEY: ((test_notify_api_key))
        NOTIFICATION_TEMPLATE_ID: 'f6404844-a994-428c-a5d7-45a4e1cfff4b'
        NOTIFY_VIA_GOV_NOTIFY: '1'
        RM_NOTIFY_GATEWAY_URL: 'http://rm-notify-gateway-concourse-latest.apps.devtest.onsclofo.uk/emails/'
        RAS_SM_PATH: '/home/vcap/app'
        SERVICE_ID: 'ce3674b1-7b08-4377-a6a7-05b5722d4ea5'
        UAA_URL: 'http://uaa-concourse-latest.apps.devtest.onsclofo.uk'
        CLIENT_ID: 'secure_message'
        CLIENT_SECRET: ((latest_secure_message_client_secret))
        USE_UAA: '1'

- name: ras-backstage-latest-deploy
  serial_groups: [ras-backstage-latest-deploy]
  plan:
  - get: ras-backstage-source
    trigger: true
    passed: [ci-rasrm-acceptance-tests, ci-securemessage-acceptance-tests]
  - put: cf-resource-latest
    params:
      current_app_name: ras-backstage-concourse-latest
      manifest: ras-backstage-source/manifest.yml
      path: ras-backstage-source
      environment_variables:
        <<: *latest_security_user
        <<: *latest_service_endpoints_for_python
        RAS_SECURE_MESSAGING_JWT_SECRET: ((latest_jwt_secret))
        UAA_CLIENT_ID: 'response_operations'
        UAA_CLIENT_SECRET: ((latest_response_operations_client_secret))
        UAA_SERVICE_URL: 'http://uaa-concourse-latest.apps.devtest.onsclofo.uk'
        USE_UAA: '1'

- name: ras-collection-instrument-latest-deploy
  serial_groups: [ras-collection-instrument-latest-deploy]
  plan:
  - get: ras-collection-instrument-source
    trigger: true
    passed: [ci-rasrm-acceptance-tests, ci-securemessage-acceptance-tests]
  - get: ras-deploy
  - put: create-rm-rabbitmq
    resource: cf-cli-resource-latest
    params:
      command: create-service
      service: rabbitmq
      plan: standard
      service_instance: rm-rabbitmq
      timeout: 1800
      wait_for_service: true
  - put: create-sdx-rabbitmq
    resource: cf-cli-resource-latest
    params:
      command: create-service
      service: rabbitmq
      plan: standard
      service_instance: sdx-rabbitmq
      timeout: 1800
      wait_for_service: true
  - put: create-database
    resource: cf-cli-resource-latest
    params:
      command: create-service
      service: rds
      plan: shared-psql
      service_instance: ras-ci-db
      timeout: 300
      wait_for_service: true
  - put: cf-resource-latest
    params:
      current_app_name: ras-collection-instrument-concourse-latest
      manifest: ras-collection-instrument-source/manifest-ci.yml
      path: ras-collection-instrument-source
      environment_variables:
        <<: *latest_security_user
        <<: *latest_service_endpoints_for_python
        JSON_SECRET_KEYS: ((latest_json_secret_keys))
        ONS_CRYPTOKEY: ((latest_collection_instrument_encryption_key))
        RABBITMQ_AMQP_COLLECTION_INSTRUMENT: ((latest_rabbitmq_amqp_collection_instrument)) # What is this queue?
        RABBITMQ_AMQP_SURVEY_RESPONSE: ((latest_rabbitmq_amqp_survey_response))

- name: ras-frontstage-latest-deploy
  serial_groups: [ras-frontstage-latest-deploy]
  plan:
  - get: ras-frontstage-source
    trigger: true
    passed: [ci-rasrm-acceptance-tests, ci-securemessage-acceptance-tests]
  - <<: *latest_create_rm_redis
  - put: cf-resource-latest
    params:
      current_app_name: ras-frontstage-concourse-latest
      manifest: ras-frontstage-source/manifest.yml
      path: ras-frontstage-source
      environment_variables:
        <<: *latest_security_user
        <<: *latest_service_endpoints_for_python
        EQ_URL: 'https://eq-test/session?token='
        JWT_SECRET: ((latest_jwt_secret))
        JSON_SECRET_KEYS: ((latest_json_secret_keys))
        OAUTH_CLIENT_ID: 'ons@ons.gov'
        OAUTH_CLIENT_SECRET: 'password'
        SECRET_KEY: ((latest_enrolement_code_encryption_key))

- name: django-oauth2-test-latest-deploy
  serial_groups: [django-oauth2-test-latest-deploy]
  plan:
  - get: django-oauth2-test-source
    trigger: true
    passed: [ci-rasrm-acceptance-tests, ci-securemessage-acceptance-tests]
  - get: ras-deploy
  - put: create-database
    resource: cf-cli-resource-latest
    params:
      command: create-service
      service: rds
      plan: shared-psql
      service_instance: oauth-db
      timeout: 300
      wait_for_service: true
  # Create git_info file for info end point
  - task: git-info
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: paasmule/curl-ssl-git
          tag: "latest"
      inputs:
        - name: django-oauth2-test-source
      outputs:
        - name: django-oauth2-test-source-git-info
      run:
        path: sh
        args:
        - -exc
        - |
          cd django-oauth2-test-source
          branch=$(git rev-parse --abbrev-ref HEAD)
          url=$(git config --get remote.origin.url)
          commit=$(git rev-parse HEAD)
          repo=$(basename `git rev-parse --show-toplevel`)
          when=`date --utc +%FT%TZ`
          output=git_info
          echo '{' > ${output}
          echo   \"origin\": \"${url}\", >> ${output}
          echo   \"commit\": \"${commit}\", >> ${output}
          echo   \"branch\": \"${branch}\", >> ${output}
          echo   \"name\": \"${repo}\", >> ${output}
          echo   \"built\": \"${when}\" >> ${output}
          echo '}' >> ${output}
          cd ..
          cp -r django-oauth2-test-source/* django-oauth2-test-source-git-info
  - put: cf-resource-latest
    params:
      current_app_name: django-oauth2-test-concourse-latest
      manifest: django-oauth2-test-source-git-info/manifest.yml
      path: django-oauth2-test-source-git-info
      environment_variables:
        <<: *latest_security_user
        CSRF_ENABLED: 'True'
        DEBUG: 'False'
        DJANGO_SETTINGS_MODULE: 'proj.settings.cloud_foundry_settings'
        OAUTH2_SUPER_USER: ((latest_oauth2_super_user))
        OAUTH2_SUPER_USER_EMAIL: ((latest_oauth2_super_user_email))
        OAUTH2_SUPER_USER_PASSWORD: ((latest_oauth2_super_user_password))
        SECRET_KEY: ((latest_jwt_secret))
        TESTING: 'False'
  - task: create-super-user
    file: ras-deploy/tasks/django-oauth2-test/create_default_user.yml
    params:
      CLOUDFOUNDRY_API: ((cloudfoundry_api))
      CLOUDFOUNDRY_EMAIL: ((cloudfoundry_email))
      CLOUDFOUNDRY_PASSWORD: ((cloudfoundry_password))
      CLOUDFOUNDRY_ORG: rmras
      CLOUDFOUNDRY_SPACE: concourse-latest
      APP_NAME: django-oauth2-test-concourse-latest

- name: response-operations-ui-latest-deploy
  serial_groups: [response-operations-ui-latest-deploy]
  plan:
  - get: response-operations-ui-source
    trigger: true
    passed: [ci-rasrm-acceptance-tests, ci-securemessage-acceptance-tests]
  - put: create-redis
    resource: cf-cli-resource-latest
    params:
      command: create-service
      service: elasticache-broker
      plan: small
      service_instance: ras-redis
      timeout: 1800
      wait_for_service: true
  - put: cf-resource-latest
    params:
      current_app_name: response-operations-ui-concourse-latest
      manifest: response-operations-ui-source/manifest.yml
      path: response-operations-ui-source
      environment_variables:
        <<: *latest_security_user
        <<: *latest_service_endpoints_for_python
        RAS_SECURE_MESSAGING_JWT_SECRET: ((latest_jwt_secret))
        REDIS_SERVICE: ras-redis
        UAA_CLIENT_ID: 'response_operations'
        UAA_CLIENT_SECRET: ((latest_response_operations_client_secret))

- name: rm-action-service-latest-deploy
  serial_groups: [rm-action-service-latest-deploy]
  plan:
  - get: rm-action-service-source
    trigger: true
    passed: [ci-rasrm-acceptance-tests, ci-securemessage-acceptance-tests]
  - aggregate:
    - <<: *latest_create_rm_pg_db
    - <<: *latest_create_rm_redis
    - <<: *latest_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-action-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-action-service-source/.maven.settings.xml install -Ddockerfile.skip -f rm-action-service-source/pom.xml
            cp -r rm-action-service-source/target/ .
  - put: cf-resource-latest
    params:
      current_app_name: rm-action-service-concourse-latest
      manifest: rm-action-service-source/manifest-no-envs.yml
      path: target/actionsvc*.jar
      environment_variables:
        <<: *latest_security_user
        <<: *latest_service_endpoints_for_java
        endpoints_enabled: 'false'

- name: rm-actionexporter-service-latest-deploy
  serial_groups: [rm-actionexporter-service-latest-deploy]
  plan:
  - get: rm-actionexporter-service-source
    trigger: true
    passed: [ci-rasrm-acceptance-tests, ci-securemessage-acceptance-tests]
  - aggregate:
    - <<: *latest_create_rm_pg_db
    - <<: *latest_create_rm_redis
    - <<: *latest_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-actionexporter-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-actionexporter-service-source/.maven.settings.xml install -Ddockerfile.skip -f rm-actionexporter-service-source/pom.xml
            cp -r rm-actionexporter-service-source/target/ .
  - put: cf-resource-latest
    params:
      current_app_name: rm-actionexporter-service-concourse-latest
      manifest: rm-actionexporter-service-source/manifest.yml
      path: target/actionexportersvc*.jar
      environment_variables:
        <<: *latest_security_user
        endpoints_enabled: 'false'
        exportSchedule_cronExpression: '0 * * * * ?'
        sftp_host: ((sftp_host))
        sftp_password: ((actionexporter_sftp_password))
        sftp_port: '22'
        sftp_username: ((actionexporter_sftp_username))

- name: rm-case-service-latest-deploy
  serial_groups: [rm-case-service-latest-deploy]
  plan:
  - get: rm-case-service-source
    trigger: true
    passed: [ci-rasrm-acceptance-tests, ci-securemessage-acceptance-tests]
  - aggregate:
    - <<: *latest_create_rm_pg_db
    - <<: *latest_create_rm_redis
    - <<: *latest_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-case-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-case-service-source/.maven.settings.xml install -Ddockerfile.skip -f rm-case-service-source/pom.xml
            cp -r rm-case-service-source/target/ .
  - put: cf-resource-latest
    params:
      current_app_name: rm-case-service-concourse-latest
      manifest: rm-case-service-source/manifest-no-envs.yml
      path: target/casesvc*.jar
      environment_variables:
        <<: *latest_security_user
        <<: *latest_service_endpoints_for_java
        endpoints_enabled: 'false'

- name: rm-collection-exercise-latest-deploy
  serial_groups: [rm-collection-exercise-latest-deploy]
  plan:
  - get: rm-collection-exercise-service-source
    trigger: true
    passed: [ci-rasrm-acceptance-tests, ci-securemessage-acceptance-tests]
  - aggregate:
    - <<: *latest_create_rm_pg_db
    - <<: *latest_create_rm_redis
    - <<: *latest_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-collection-exercise-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-collection-exercise-service-source/.maven.settings.xml install -Ddockerfile.skip -Ddocker.skip -DskipITs -f rm-collection-exercise-service-source/pom.xml
            cp -r rm-collection-exercise-service-source/target/ .
  - put: cf-resource-latest
    params:
      current_app_name: rm-collection-exercise-service-concourse-latest
      manifest: rm-collection-exercise-service-source/manifest-no-envs.yml
      path: target/collectionexercisesvc*.jar
      environment_variables:
        <<: *latest_security_user
        <<: *latest_service_endpoints_for_java
        endpoints_enabled: 'false'
        SCHEDULES_VALIDATION_SCHEDULE_DELAY_MILLI_SECONDS: '1000'
        SCHEDULES_DISTRIBUTION_SCHEDULE_DELAY_MILLI_SECONDS: '1000'

- name: iac-service-latest-deploy
  serial_groups: [iac-service-latest-deploy]
  plan:
  - get: iac-service-source
    trigger: true
    passed: [ci-rasrm-acceptance-tests, ci-securemessage-acceptance-tests]
  - aggregate:
    - <<: *latest_create_rm_pg_db
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: iac-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings iac-service-source/.maven.settings.xml install -Ddockerfile.skip -f iac-service-source/pom.xml
            cp -r iac-service-source/target/ .
  - put: cf-resource-latest
    params:
      current_app_name: iac-service-concourse-latest
      manifest: iac-service-source/manifest-no-envs.yml
      path: target/iacsvc*.jar
      environment_variables:
        <<: *latest_security_user
        <<: *latest_service_endpoints_for_java
        endpoints_enabled: 'false'

- name: rm-notify-gateway-latest-deploy
  serial_groups: [rm-notify-gateway-latest-deploy]
  plan:
  - get: rm-notify-gateway-source
    trigger: true
    passed: [ci-rasrm-acceptance-tests, ci-securemessage-acceptance-tests]
  - aggregate:
    - <<: *latest_create_rm_pg_db
    - <<: *latest_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-notify-gateway-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-notify-gateway-source/.maven.settings.xml install -Ddockerfile.skip -f rm-notify-gateway-source/pom.xml
            cp -r rm-notify-gateway-source/target/ .
  - put: cf-resource-latest
    params:
      current_app_name: rm-notify-gateway-concourse-latest
      manifest: rm-notify-gateway-source/manifest.yml
      path: target/notifygatewaysvc*.jar
      environment_variables:
        <<: *latest_security_user
        endpoints_enabled: 'false'
        notify_apiKey: ((test_notify_api_key))
        notify_censusUacSmsTemplateId: '966731dc-ef2e-41ad-a828-8cdd95c81ebc'
        notify_enabled: 'false'
        notify_onsSurveysRasEmailReminderTemplateId: '19a0aa89-797f-4a34-ad54-267fd581f2ef'

- name: rm-sample-service-latest-deploy
  serial_groups: [rm-sample-service-latest-deploy]
  plan:
  - get: rm-sample-service-source
    trigger: true
    passed: [ci-rasrm-acceptance-tests, ci-securemessage-acceptance-tests]
  - aggregate:
    - <<: *latest_create_rm_pg_db
    - <<: *latest_create_rm_redis
    - <<: *latest_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-sample-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-sample-service-source/.maven.settings.xml install -Ddockerfile.skip -Ddocker.skip -DskipITs -f rm-sample-service-source/pom.xml
            cp -r rm-sample-service-source/target/ .
  - put: cf-resource-latest
    params:
      current_app_name: rm-sample-service-concourse-latest
      manifest: rm-sample-service-source/manifest-no-envs.yml
      path: target/samplesvc*.jar
      environment_variables:
        <<: *latest_security_user
        <<: *latest_service_endpoints_for_java
        SAMPLE_UNIT_DISTRIBUTION_DELAY_MILLI_SECONDS: '1000'
        endpoints_enabled: 'false'
        exportSchedule_cronExpression: '0 0/5 * * * ?'
        sftp_host: ((sftp_host))
        sftp_password: ((sample_sftp_password))
        sftp_port: '22'
        sftp_username: ((sample_sftp_username))

- name: rm-sdx-gateway-latest-deploy
  serial_groups: [rm-sdx-gateway-latest-deploy]
  plan:
  - get: rm-sdx-gateway-source
    trigger: true
    passed: [ci-rasrm-acceptance-tests, ci-securemessage-acceptance-tests]
  - aggregate:
    - <<: *latest_create_rm_redis
    - <<: *latest_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-sdx-gateway-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-sdx-gateway-source/.maven.settings.xml install -Ddockerfile.skip -f rm-sdx-gateway-source/pom.xml
            cp -r rm-sdx-gateway-source/target/ .
  - put: cf-resource-latest
    params:
      current_app_name: rm-sdx-gateway-concourse-latest
      manifest: rm-sdx-gateway-source/manifest.yml
      path: target/sdxgatewaysvc*.jar
      environment_variables:
        <<: *latest_security_user
        endpoints_enabled: 'false'

- name: rm-survey-service-latest-deploy
  serial_groups: [rm-survey-service-latest-deploy]
  plan:
  - get: rm-survey-service-source
    trigger: true
    passed: [ci-rasrm-acceptance-tests, ci-securemessage-acceptance-tests]
  - aggregate:
    - <<: *latest_create_rm_pg_db
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: golang
        inputs:
          - name: rm-survey-service-source
        outputs:
          - name: rm-survey-service-build
            path: rm-survey-service
        run:
          path: sh
          args:
          - -exc
          - |
            mkdir -p /go/src/github.com/ONSdigital/
            cp -r rm-survey-service-source /go/src/github.com/ONSdigital/rm-survey-service
            make -C /go/src/github.com/ONSdigital/rm-survey-service
            cp -r /go/src/github.com/ONSdigital/rm-survey-service/ .
  - put: cf-resource-latest
    params:
      current_app_name: rm-survey-service-concourse-latest
      manifest: rm-survey-service-source/manifest.yml
      path: rm-survey-service-build
      environment_variables:
        <<: *latest_security_user
        MIGRATION_SOURCE: 'file://db-migrations'

- name: sdc-uaa-latest-deploy
  serial_groups: [sdc-uaa-latest-deploy]
  plan:
  - get: sdc-uaa-source
    trigger: true
    passed: [ci-rasrm-acceptance-tests, ci-securemessage-acceptance-tests]
  - task: build
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: sdcplatform/maven-cf-cli-docker
      inputs:
        - name: sdc-uaa-source
      outputs:
        - name: sdc-uaa-build
          path: sdc-uaa-build
      params:
        UAA_PRIVATE_KEY: ((latest_uaa_private_key))
        UAA_CERTIFICATE: ((latest_uaa_certificate))
        UAA_PRIVATE_KEY_PASSWORD: ((latest_uaa_private_key_password))
        JENKINS_CF_USERNAME: ((cloudfoundry_email))
        JENKINS_CF_PASSWORD: ((cloudfoundry_password))
        API_ENDPOINT: ((cloudfoundry_api))
        ORG: rmras
        SPACE: concourse-latest
        UAA_ID: ((latest_uaa_id))
        UAA_SECRET: ((latest_uaa_secret))
        UAA_JWT_SIGNING_KEY: ((latest_uaa_jwt_signing_key))
        UAA_JWT_VERIFICATION_KEY: ((latest_uaa_jwt_verification_key))
        UAA_URL: 'http://uaa-concourse-latest.apps.devtest.onsclofo.uk'
        LOGIN_URL: 'http://uaa-concourse-latest.apps.devtest.onsclofo.uk'
        ZONE_URL: 'uaa-concourse-latest.apps.devtest.onsclofo.uk'
        ADMIN_SECRET: ((latest_uaa_admin_secret))
        LOGIN_SECRET: ((latest_uaa_login_secret))
      run:
        path: sh
        args:
        - -exc
        - |
          (cd sdc-uaa-source && ls && sh deploy-uaa-pre-steps.sh dev)
          mvn install -f sdc-uaa-source/pom.xml
          cp -r sdc-uaa-source/* sdc-uaa-build
  - put: cf-resource-latest
    params:
      current_app_name: sdc-uaa-concourse-latest
      manifest: sdc-uaa-build/uaa-cf-application.yml
      #### EXTRACT ME ####
  - task: create-secure-message-client
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: kennethreitz/pipenv
      inputs:
        - name: sdc-uaa-source
      params:
        SPACE: concourse-latest
        CLIENT: secure_message
        PASSWORD: ((latest_secure_message_client_secret))
        ADMIN_SECRET: ((latest_uaa_admin_secret))
        UAA_URL: 'uaa-concourse-latest.apps.devtest.onsclofo.uk'
      run:
        dir: sdc-uaa-source
        path: sh
        args:
        - './scripts/jenkins/add_client.sh'
  - task: create-response_operations-client
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: kennethreitz/pipenv
      inputs:
        - name: sdc-uaa-source
      params:
        SPACE: concourse-latest
        CLIENT: response_operations
        PASSWORD: ((latest_response_operations_client_secret))
        ADMIN_SECRET: ((latest_uaa_admin_secret))
        UAA_URL: 'uaa-concourse-latest.apps.devtest.onsclofo.uk'
      run:
        dir: sdc-uaa-source
        path: sh
        args:
        - './scripts/jenkins/add_client.sh'
  - task: create-uaa-user
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: kennethreitz/pipenv
      inputs:
        - name: sdc-uaa-source
      params:
        SPACE: concourse-latest
        USERNAME: uaa_user
        PASSWORD: ((latest_uaa_user_password))
        EMAIL: ons@ons.gov
        FIRSTNAME: uaa
        LASTNAME: user
        ADMIN_SECRET: ((latest_uaa_admin_secret))
        UAA_URL: 'uaa-concourse-latest.apps.devtest.onsclofo.uk'
      run:
        dir: sdc-uaa-source
        path: sh
        args:
        - './scripts/jenkins/add_user.sh'
### END latest SPACE DEPLOYMENTS

- name: latest-acceptance-tests
  serial_groups: *latest_all_services
  plan:
  - get: ras-deploy
  - get: rasrm-acceptance-tests-source
    trigger: true
    passed: [ci-rasrm-acceptance-tests,ci-securemessage-acceptance-tests]
  - get: ras-party-source
    passed: [ras-party-latest-deploy]
    trigger: true
  - get: ras-backstage-source
    passed: [ras-backstage-latest-deploy]
    trigger: true
  - get: ras-frontstage-source
    passed: [ras-frontstage-latest-deploy]
    trigger: true
  - get: django-oauth2-test-source
    passed: [django-oauth2-test-latest-deploy]
    trigger: true
  - get: response-operations-ui-source
    passed: [response-operations-ui-latest-deploy]
    trigger: true
  - get: ras-secure-message-source
    passed: [ras-secure-message-latest-deploy]
    trigger: true
  - get: ras-collection-instrument-source
    passed: [ras-collection-instrument-latest-deploy]
    trigger: true
  - get: rm-action-service-source
    passed: [rm-action-service-latest-deploy]
    trigger: true
  - get: rm-actionexporter-service-source
    passed: [rm-actionexporter-service-latest-deploy]
    trigger: true
  - get: rm-case-service-source
    passed: [rm-case-service-latest-deploy]
    trigger: true
  - get: rm-collection-exercise-service-source
    passed: [rm-collection-exercise-latest-deploy]
    trigger: true
  - get: iac-service-source
    passed: [iac-service-latest-deploy]
    trigger: true
  - get: rm-notify-gateway-source
    passed: [rm-notify-gateway-latest-deploy]
    trigger: true
  - get: rm-sample-service-source
    passed: [rm-sample-service-latest-deploy]
    trigger: true
  - get: rm-sdx-gateway-source
    passed: [rm-sdx-gateway-latest-deploy]
    trigger: true
  - get: rm-survey-service-source
    passed: [rm-survey-service-latest-deploy]
    trigger: true
  - get: sdc-uaa-source
    passed: [sdc-uaa-latest-deploy]
    trigger: true
  - task: get-cf-database-uris
    file: ras-deploy/tasks/get_database_uris.yml
    params:
      CLOUDFOUNDRY_API: ((cloudfoundry_api))
      CLOUDFOUNDRY_EMAIL: ((cloudfoundry_email))
      CLOUDFOUNDRY_PASSWORD: ((cloudfoundry_password))
      CLOUDFOUNDRY_ORG: rmras
      CLOUDFOUNDRY_SPACE: concourse-latest

  - task: acceptance-test
    privileged: true
    file: ras-deploy/tasks/rasrm-acceptance-tests/run_acceptance_tests.yml
    params:
      <<: *latest_security_user
      <<: *latest_service_endpoints_for_python
      MAKE_TARGET: acceptance_tests

disabled-jobs:
- name: preprod-trigger
  disable_manual_trigger: true
  plan:
  - get: preprod-deploy-trigger
    trigger: true
  - get: ras-party-source
    passed: [latest-acceptance-tests]
  - get: ras-backstage-source
    passed: [latest-acceptance-tests]
  - get: ras-frontstage-source
    passed: [latest-acceptance-tests]
  - get: django-oauth2-test-source
    passed: [latest-acceptance-tests]
  - get: response-operations-ui-source
    passed: [latest-acceptance-tests]
  - get: ras-secure-message-source
    passed: [latest-acceptance-tests]
  - get: ras-collection-instrument-source
    passed: [latest-acceptance-tests]
  - get: rm-action-service-source
    passed: [latest-acceptance-tests]
  - get: rm-actionexporter-service-source
    passed: [latest-acceptance-tests]
  - get: rm-case-service-source
    passed: [latest-acceptance-tests]
  - get: rm-collection-exercise-service-source
    passed: [latest-acceptance-tests]
  - get: iac-service-source
    passed: [latest-acceptance-tests]
  - get: rm-notify-gateway-source
    passed: [latest-acceptance-tests]
  - get: rm-sample-service-source
    passed: [latest-acceptance-tests]
  - get: rm-sdx-gateway-source
    passed: [latest-acceptance-tests]
  - get: rm-survey-service-source
    passed: [latest-acceptance-tests]
  - get: sdc-uaa-source
    passed: [latest-acceptance-tests]

### START preprod SPACE DEPLOYMENTS
- name: ras-party-preprod-deploy
  disable_manual_trigger: true
  serial_groups: [ras-party-preprod-deploy]
  plan:
  - get: ras-party-source
    trigger: true
    passed: [preprod-trigger]
  - put: create-database
    resource: cf-cli-resource-preprod
    params:
      command: create-service
      service: rds
      plan: shared-psql
      service_instance: ras-party-db
      timeout: 300
      wait_for_service: true
  - put: push-app
    resource: cf-resource-preprod
    params:
      current_app_name: ras-party-concourse-preprod
      manifest: ras-party-source/manifest.yml
      path: ras-party-source
      environment_variables:
        <<: *preprod_security_user
        <<: *preprod_service_endpoints_for_python
        RAS_NOTIFY_CONFIRM_PASSWORD_CHANGE_TEMPLATE: ba41c152-ad96-4255-9456-9e42de83f510
        RAS_NOTIFY_EMAIL_VERIFICATION_TEMPLATE: 53c59576-8c3b-4298-99d1-b245ddd28500
        RAS_NOTIFY_REQUEST_PASSWORD_CHANGE_TEMPLATE: c45c59ff-7771-4de4-a66b-ce50b108390a
        RAS_NOTIFY_SERVICE_URL: http://rm-notify-gateway-concourse-preprod.apps.devtest.onsclofo.uk/emails/

- name: ras-secure-message-preprod-deploy
  disable_manual_trigger: true
  serial_groups: [ras-secure-message-preprod-deploy]
  plan:
  - get: ras-secure-message-source
    trigger: true
    passed: [preprod-trigger]
  - put: create-database
    resource: cf-cli-resource-preprod
    params:
      command: create-service
      service: rds
      plan: shared-psql
      service_instance: secure-message-db
      timeout: 300
      wait_for_service: true
  - put: cf-resource-preprod
    params:
      current_app_name: ras-secure-message-concourse-preprod
      manifest: ras-secure-message-source/manifest.yml
      path: ras-secure-message-source
      environment_variables:
        <<: *preprod_security_user
        <<: *preprod_service_endpoints_for_python
        JWT_ALGORITHM: 'HS256'
        JWT_SECRET: ((preprod_jwt_secret))
        NOTIFICATION_API_KEY: ((test_notify_api_key))
        NOTIFICATION_TEMPLATE_ID: 'f6404844-a994-428c-a5d7-45a4e1cfff4b'
        NOTIFY_VIA_GOV_NOTIFY: '1'
        RM_NOTIFY_GATEWAY_URL: 'http://rm-notify-gateway-concourse-preprod.apps.devtest.onsclofo.uk/emails/'
        RAS_SM_PATH: '/home/vcap/app'
        SERVICE_ID: 'ce3674b1-7b08-4377-a6a7-05b5722d4ea5'
        UAA_URL: 'http://uaa-concourse-preprod.apps.devtest.onsclofo.uk'
        CLIENT_ID: 'secure_message'
        CLIENT_SECRET: ((preprod_secure_message_client_secret))
        USE_UAA: '1'

- name: ras-backstage-preprod-deploy
  disable_manual_trigger: true
  serial_groups: [ras-backstage-preprod-deploy]
  plan:
  - get: ras-backstage-source
    trigger: true
    passed: [preprod-trigger]
  - put: cf-resource-preprod
    params:
      current_app_name: ras-backstage-concourse-preprod
      manifest: ras-backstage-source/manifest.yml
      path: ras-backstage-source
      environment_variables:
        <<: *preprod_security_user
        <<: *preprod_service_endpoints_for_python
        RAS_SECURE_MESSAGING_JWT_SECRET: ((preprod_jwt_secret))
        UAA_CLIENT_ID: 'response_operations'
        UAA_CLIENT_SECRET: ((preprod_response_operations_client_secret))
        UAA_SERVICE_URL: 'http://uaa-concourse-preprod.apps.devtest.onsclofo.uk'
        USE_UAA: '1'

- name: ras-collection-instrument-preprod-deploy
  disable_manual_trigger: true
  serial_groups: [ras-collection-instrument-preprod-deploy]
  plan:
  - get: ras-collection-instrument-source
    trigger: true
    passed: [preprod-trigger]
  - get: ras-deploy
  - put: create-rm-rabbitmq
    resource: cf-cli-resource-preprod
    params:
      command: create-service
      service: rabbitmq
      plan: standard
      service_instance: rm-rabbitmq
      timeout: 1800
      wait_for_service: true
  - put: create-sdx-rabbitmq
    resource: cf-cli-resource-preprod
    params:
      command: create-service
      service: rabbitmq
      plan: standard
      service_instance: sdx-rabbitmq
      timeout: 1800
      wait_for_service: true
  - put: create-database
    resource: cf-cli-resource-preprod
    params:
      command: create-service
      service: rds
      plan: shared-psql
      service_instance: ras-ci-db
      timeout: 300
      wait_for_service: true
  - put: cf-resource-preprod
    params:
      current_app_name: ras-collection-instrument-concourse-preprod
      manifest: ras-collection-instrument-source/manifest-ci.yml
      path: ras-collection-instrument-source
      environment_variables:
        <<: *preprod_security_user
        <<: *preprod_service_endpoints_for_python
        JSON_SECRET_KEYS: ((preprod_json_secret_keys))
        ONS_CRYPTOKEY: ((preprod_collection_instrument_encryption_key))
        RABBITMQ_AMQP_COLLECTION_INSTRUMENT: ((preprod_rabbitmq_amqp_collection_instrument)) # What is this queue?
        RABBITMQ_AMQP_SURVEY_RESPONSE: ((preprod_rabbitmq_amqp_survey_response))

- name: ras-frontstage-preprod-deploy
  disable_manual_trigger: true
  serial_groups: [ras-frontstage-preprod-deploy]
  plan:
  - get: ras-frontstage-source
    trigger: true
    passed: [preprod-trigger]
  - <<: *preprod_create_rm_redis
  - put: cf-resource-preprod
    params:
      current_app_name: ras-frontstage-concourse-preprod
      manifest: ras-frontstage-source/manifest.yml
      path: ras-frontstage-source
      environment_variables:
        <<: *preprod_security_user
        <<: *preprod_service_endpoints_for_python
        EQ_URL: 'https://eq-test/session?token='
        JSON_SECRET_KEYS: ((preprod_json_secret_keys))
        JWT_SECRET: ((preprod_jwt_secret))
        OAUTH_CLIENT_ID: 'ons@ons.gov'
        OAUTH_CLIENT_SECRET: 'password'
        SECRET_KEY: ((preprod_enrolement_code_encryption_key))

- name: django-oauth2-test-preprod-deploy
  disable_manual_trigger: true
  serial_groups: [django-oauth2-test-preprod-deploy]
  plan:
  - get: django-oauth2-test-source
    trigger: true
    passed: [preprod-trigger]
  - get: ras-deploy
  - put: create-database
    resource: cf-cli-resource-preprod
    params:
      command: create-service
      service: rds
      plan: shared-psql
      service_instance: oauth-db
      timeout: 300
      wait_for_service: true
  # Create git_info file for info end point
  - task: git-info
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: paasmule/curl-ssl-git
          tag: "latest"
      inputs:
        - name: django-oauth2-test-source
      outputs:
        - name: django-oauth2-test-source-git-info
      run:
        path: sh
        args:
        - -exc
        - |
          cd django-oauth2-test-source
          branch=$(git rev-parse --abbrev-ref HEAD)
          url=$(git config --get remote.origin.url)
          commit=$(git rev-parse HEAD)
          repo=$(basename `git rev-parse --show-toplevel`)
          when=`date --utc +%FT%TZ`
          output=git_info
          echo '{' > ${output}
          echo   \"origin\": \"${url}\", >> ${output}
          echo   \"commit\": \"${commit}\", >> ${output}
          echo   \"branch\": \"${branch}\", >> ${output}
          echo   \"name\": \"${repo}\", >> ${output}
          echo   \"built\": \"${when}\" >> ${output}
          echo '}' >> ${output}
          cd ..
          cp -r django-oauth2-test-source/* django-oauth2-test-source-git-info
  - put: cf-resource-preprod
    params:
      current_app_name: django-oauth2-test-concourse-preprod
      manifest: django-oauth2-test-source-git-info/manifest.yml
      path: django-oauth2-test-source-git-info
      environment_variables:
        <<: *preprod_security_user
        CSRF_ENABLED: 'True'
        DEBUG: 'False'
        DJANGO_SETTINGS_MODULE: 'proj.settings.cloud_foundry_settings'
        OAUTH2_SUPER_USER: ((preprod_oauth2_super_user))
        OAUTH2_SUPER_USER_EMAIL: ((preprod_oauth2_super_user_email))
        OAUTH2_SUPER_USER_PASSWORD: ((preprod_oauth2_super_user_password))
        SECRET_KEY: ((preprod_jwt_secret))
        TESTING: 'False'
  - task: create-super-user
    file: ras-deploy/tasks/django-oauth2-test/create_default_user.yml
    params:
      CLOUDFOUNDRY_API: ((cloudfoundry_api))
      CLOUDFOUNDRY_EMAIL: ((cloudfoundry_email))
      CLOUDFOUNDRY_PASSWORD: ((cloudfoundry_password))
      CLOUDFOUNDRY_ORG: rmras
      CLOUDFOUNDRY_SPACE: concourse-preprod
      APP_NAME: django-oauth2-test-concourse-preprod

- name: response-operations-ui-preprod-deploy
  disable_manual_trigger: true
  serial_groups: [response-operations-ui-preprod-deploy]
  plan:
  - get: response-operations-ui-source
    trigger: true
    passed: [preprod-trigger]
  - put: create-redis
    resource: cf-cli-resource-preprod
    params:
      command: create-service
      service: elasticache-broker
      plan: small
      service_instance: ras-redis
      timeout: 1800
      wait_for_service: true
  - put: cf-resource-preprod
    params:
      current_app_name: response-operations-ui-concourse-preprod
      manifest: response-operations-ui-source/manifest.yml
      path: response-operations-ui-source
      environment_variables:
        <<: *preprod_security_user
        <<: *preprod_service_endpoints_for_python
        RAS_SECURE_MESSAGING_JWT_SECRET: ((preprod_jwt_secret))
        REDIS_SERVICE: ras-redis
        UAA_CLIENT_ID: 'response_operations'
        UAA_CLIENT_SECRET: ((preprod_response_operations_client_secret))

- name: rm-action-service-preprod-deploy
  disable_manual_trigger: true
  serial_groups: [rm-action-service-preprod-deploy]
  plan:
  - get: rm-action-service-source
    trigger: true
    passed: [preprod-trigger]
  - aggregate:
    - <<: *preprod_create_rm_pg_db
    - <<: *preprod_create_rm_redis
    - <<: *preprod_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-action-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-action-service-source/.maven.settings.xml install -Ddockerfile.skip -f rm-action-service-source/pom.xml
            cp -r rm-action-service-source/target/ .
  - put: cf-resource-preprod
    params:
      current_app_name: rm-action-service-concourse-preprod
      manifest: rm-action-service-source/manifest-no-envs.yml
      path: target/actionsvc*.jar
      environment_variables:
        <<: *preprod_security_user
        <<: *preprod_service_endpoints_for_java
        endpoints_enabled: 'false'

- name: rm-actionexporter-service-preprod-deploy
  disable_manual_trigger: true
  serial_groups: [rm-actionexporter-service-preprod-deploy]
  plan:
  - get: rm-actionexporter-service-source
    trigger: true
    passed: [preprod-trigger]
  - aggregate:
    - <<: *preprod_create_rm_pg_db
    - <<: *preprod_create_rm_redis
    - <<: *preprod_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-actionexporter-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-actionexporter-service-source/.maven.settings.xml install -Ddockerfile.skip -f rm-actionexporter-service-source/pom.xml
            cp -r rm-actionexporter-service-source/target/ .
  - put: cf-resource-preprod
    params:
      current_app_name: rm-actionexporter-service-concourse-preprod
      manifest: rm-actionexporter-service-source/manifest.yml
      path: target/actionexportersvc*.jar
      environment_variables:
        <<: *preprod_security_user
        endpoints_enabled: 'false'
        exportSchedule_cronExpression: '0 * * * * ?'
        sftp_host: ((sftp_host))
        sftp_password: ((actionexporter_sftp_password))
        sftp_port: '22'
        sftp_username: ((actionexporter_sftp_username))

- name: rm-case-service-preprod-deploy
  disable_manual_trigger: true
  serial_groups: [rm-case-service-preprod-deploy]
  plan:
  - get: rm-case-service-source
    trigger: true
    passed: [preprod-trigger]
  - aggregate:
    - <<: *preprod_create_rm_pg_db
    - <<: *preprod_create_rm_redis
    - <<: *preprod_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-case-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-case-service-source/.maven.settings.xml install -Ddockerfile.skip -f rm-case-service-source/pom.xml
            cp -r rm-case-service-source/target/ .
  - put: cf-resource-preprod
    params:
      current_app_name: rm-case-service-concourse-preprod
      manifest: rm-case-service-source/manifest-no-envs.yml
      path: target/casesvc*.jar
      environment_variables:
        <<: *preprod_security_user
        <<: *preprod_service_endpoints_for_java
        endpoints_enabled: 'false'

- name: rm-collection-exercise-preprod-deploy
  disable_manual_trigger: true
  serial_groups: [rm-collection-exercise-preprod-deploy]
  plan:
  - get: rm-collection-exercise-service-source
    trigger: true
    passed: [preprod-trigger]
  - aggregate:
    - <<: *preprod_create_rm_pg_db
    - <<: *preprod_create_rm_redis
    - <<: *preprod_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-collection-exercise-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-collection-exercise-service-source/.maven.settings.xml install -Ddockerfile.skip -Ddocker.skip -DskipITs-f rm-collection-exercise-service-source/pom.xml
            cp -r rm-collection-exercise-service-source/target/ .
  - put: cf-resource-preprod
    params:
      current_app_name: rm-collection-exercise-service-concourse-preprod
      manifest: rm-collection-exercise-service-source/manifest-no-envs.yml
      path: target/collectionexercisesvc*.jar
      environment_variables:
        <<: *preprod_security_user
        <<: *preprod_service_endpoints_for_java
        endpoints_enabled: 'false'
        SCHEDULES_VALIDATION_SCHEDULE_DELAY_MILLI_SECONDS: '1000'
        SCHEDULES_DISTRIBUTION_SCHEDULE_DELAY_MILLI_SECONDS: '1000'

- name: iac-service-preprod-deploy
  disable_manual_trigger: true
  serial_groups: [iac-service-preprod-deploy]
  plan:
  - get: iac-service-source
    trigger: true
    passed: [preprod-trigger]
  - aggregate:
    - <<: *preprod_create_rm_pg_db
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: iac-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings iac-service-source/.maven.settings.xml install -Ddockerfile.skip -f iac-service-source/pom.xml
            cp -r iac-service-source/target/ .
  - put: cf-resource-preprod
    params:
      current_app_name: iac-service-concourse-preprod
      manifest: iac-service-source/manifest-no-envs.yml
      path: target/iacsvc*.jar
      environment_variables:
        <<: *preprod_security_user
        <<: *preprod_service_endpoints_for_java
        endpoints_enabled: 'false'

- name: rm-notify-gateway-preprod-deploy
  disable_manual_trigger: true
  serial_groups: [rm-notify-gateway-preprod-deploy]
  plan:
  - get: rm-notify-gateway-source
    trigger: true
    passed: [preprod-trigger]
  - aggregate:
    - <<: *preprod_create_rm_pg_db
    - <<: *preprod_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-notify-gateway-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-notify-gateway-source/.maven.settings.xml install -Ddockerfile.skip -f rm-notify-gateway-source/pom.xml
            cp -r rm-notify-gateway-source/target/ .
  - put: cf-resource-preprod
    params:
      current_app_name: rm-notify-gateway-concourse-preprod
      manifest: rm-notify-gateway-source/manifest.yml
      path: target/notifygatewaysvc*.jar
      environment_variables:
        <<: *preprod_security_user
        endpoints_enabled: 'false'
        notify_apiKey: ((test_notify_api_key))
        notify_censusUacSmsTemplateId: '966731dc-ef2e-41ad-a828-8cdd95c81ebc'
        notify_enabled: 'false'
        notify_onsSurveysRasEmailReminderTemplateId: '19a0aa89-797f-4a34-ad54-267fd581f2ef'

- name: rm-sample-service-preprod-deploy
  disable_manual_trigger: true
  serial_groups: [rm-sample-service-preprod-deploy]
  plan:
  - get: rm-sample-service-source
    trigger: true
    passed: [preprod-trigger]
  - aggregate:
    - <<: *preprod_create_rm_pg_db
    - <<: *preprod_create_rm_redis
    - <<: *preprod_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-sample-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-sample-service-source/.maven.settings.xml install -Ddockerfile.skip -Ddocker.skip -DskipITs -f rm-sample-service-source/pom.xml
            cp -r rm-sample-service-source/target/ .
  - put: cf-resource-preprod
    params:
      current_app_name: rm-sample-service-concourse-preprod
      manifest: rm-sample-service-source/manifest-no-envs.yml
      path: target/samplesvc*.jar
      environment_variables:
        <<: *preprod_security_user
        <<: *preprod_service_endpoints_for_java
        SAMPLE_UNIT_DISTRIBUTION_DELAY_MILLI_SECONDS: '1000'
        endpoints_enabled: 'false'
        exportSchedule_cronExpression: '0 0/5 * * * ?'
        sftp_host: ((sftp_host))
        sftp_password: ((sample_sftp_password))
        sftp_port: '22'
        sftp_username: ((sample_sftp_username))

- name: rm-sdx-gateway-preprod-deploy
  disable_manual_trigger: true
  serial_groups: [rm-sdx-gateway-preprod-deploy]
  plan:
  - get: rm-sdx-gateway-source
    trigger: true
    passed: [preprod-trigger]
  - aggregate:
    - <<: *preprod_create_rm_redis
    - <<: *preprod_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-sdx-gateway-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-sdx-gateway-source/.maven.settings.xml install -Ddockerfile.skip -f rm-sdx-gateway-source/pom.xml
            cp -r rm-sdx-gateway-source/target/ .
  - put: cf-resource-preprod
    params:
      current_app_name: rm-sdx-gateway-concourse-preprod
      manifest: rm-sdx-gateway-source/manifest.yml
      path: target/sdxgatewaysvc*.jar
      environment_variables:
        <<: *preprod_security_user
        endpoints_enabled: 'false'

- name: rm-survey-service-preprod-deploy
  disable_manual_trigger: true
  serial_groups: [rm-survey-service-preprod-deploy]
  plan:
  - get: rm-survey-service-source
    trigger: true
    passed: [preprod-trigger]
  - aggregate:
    - <<: *preprod_create_rm_pg_db
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: golang
        inputs:
          - name: rm-survey-service-source
        outputs:
          - name: rm-survey-service-build
            path: rm-survey-service
        run:
          path: sh
          args:
          - -exc
          - |
            mkdir -p /go/src/github.com/ONSdigital/
            cp -r rm-survey-service-source /go/src/github.com/ONSdigital/rm-survey-service
            make -C /go/src/github.com/ONSdigital/rm-survey-service
            cp -r /go/src/github.com/ONSdigital/rm-survey-service/ .
  - put: cf-resource-preprod
    params:
      current_app_name: rm-survey-service-concourse-preprod
      manifest: rm-survey-service-source/manifest.yml
      path: rm-survey-service-build
      environment_variables:
        <<: *preprod_security_user
        MIGRATION_SOURCE: 'file://db-migrations'

- name: sdc-uaa-preprod-deploy
  disable_manual_trigger: true
  serial_groups: [sdc-uaa-preprod-deploy]
  plan:
  - get: sdc-uaa-source
    trigger: true
    passed: [preprod-trigger]
  - task: build
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: sdcplatform/maven-cf-cli-docker
      inputs:
        - name: sdc-uaa-source
      outputs:
        - name: sdc-uaa-build
          path: sdc-uaa-build
      params:
        UAA_PRIVATE_KEY: ((preprod_uaa_private_key))
        UAA_CERTIFICATE: ((preprod_uaa_certificate))
        UAA_PRIVATE_KEY_PASSWORD: ((preprod_uaa_private_key_password))
        JENKINS_CF_USERNAME: ((cloudfoundry_email))
        JENKINS_CF_PASSWORD: ((cloudfoundry_password))
        API_ENDPOINT: ((cloudfoundry_api))
        ORG: rmras
        SPACE: concourse-preprod
        UAA_ID: ((preprod_uaa_id))
        UAA_SECRET: ((preprod_uaa_secret))
        UAA_JWT_SIGNING_KEY: ((preprod_uaa_jwt_signing_key))
        UAA_JWT_VERIFICATION_KEY: ((preprod_uaa_jwt_verification_key))
        UAA_URL: 'http://uaa-concourse-preprod.apps.devtest.onsclofo.uk'
        LOGIN_URL: 'http://uaa-concourse-preprod.apps.devtest.onsclofo.uk'
        ZONE_URL: 'uaa-concourse-preprod.apps.devtest.onsclofo.uk'
        ADMIN_SECRET: ((preprod_uaa_admin_secret))
        LOGIN_SECRET: ((preprod_uaa_login_secret))
      run:
        path: sh
        args:
        - -exc
        - |
          (cd sdc-uaa-source && ls && sh deploy-uaa-pre-steps.sh dev)
          mvn install -f sdc-uaa-source/pom.xml
          cp -r sdc-uaa-source/* sdc-uaa-build
  - put: cf-resource-preprod
    params:
      current_app_name: sdc-uaa-concourse-preprod
      manifest: sdc-uaa-build/uaa-cf-application.yml
      #### EXTRACT ME ####
  - task: create-secure-message-client
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: kennethreitz/pipenv
      inputs:
        - name: sdc-uaa-source
      params:
        SPACE: concourse-preprod
        CLIENT: secure_message
        PASSWORD: ((preprod_secure_message_client_secret))
        ADMIN_SECRET: ((preprod_uaa_admin_secret))
        UAA_URL: 'uaa-concourse-preprod.apps.devtest.onsclofo.uk'
      run:
        dir: sdc-uaa-source
        path: sh
        args:
        - './scripts/jenkins/add_client.sh'
  - task: create-response_operations-client
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: kennethreitz/pipenv
      inputs:
        - name: sdc-uaa-source
      params:
        SPACE: concourse-preprod
        CLIENT: response_operations
        PASSWORD: ((preprod_response_operations_client_secret))
        ADMIN_SECRET: ((preprod_uaa_admin_secret))
        UAA_URL: 'uaa-concourse-preprod.apps.devtest.onsclofo.uk'
      run:
        dir: sdc-uaa-source
        path: sh
        args:
        - './scripts/jenkins/add_client.sh'
  - task: create-uaa-user
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: kennethreitz/pipenv
      inputs:
        - name: sdc-uaa-source
      params:
        SPACE: concourse-preprod
        USERNAME: uaa_user
        PASSWORD: ((preprod_uaa_user_password))
        EMAIL: ons@ons.gov
        FIRSTNAME: uaa
        LASTNAME: user
        ADMIN_SECRET: ((preprod_uaa_admin_secret))
        UAA_URL: 'uaa-concourse-preprod.apps.devtest.onsclofo.uk'
      run:
        dir: sdc-uaa-source
        path: sh
        args:
        - './scripts/jenkins/add_user.sh'
### END preprod SPACE DEPLOYMENTS

- name: preprod-smoke-tests
  serial_groups: *preprod_all_services
  plan:
  - get: ras-deploy
  - get: rasrm-acceptance-tests-source
    trigger: true
  - get: ras-party-source
    passed: [ras-party-preprod-deploy]
    trigger: true
  - get: ras-backstage-source
    passed: [ras-backstage-preprod-deploy]
    trigger: true
  - get: ras-frontstage-source
    passed: [ras-frontstage-preprod-deploy]
    trigger: true
  - get: django-oauth2-test-source
    passed: [django-oauth2-test-preprod-deploy]
    trigger: true
  - get: response-operations-ui-source
    passed: [response-operations-ui-preprod-deploy]
    trigger: true
  - get: ras-secure-message-source
    passed: [ras-secure-message-preprod-deploy]
    trigger: true
  - get: ras-collection-instrument-source
    passed: [ras-collection-instrument-preprod-deploy]
    trigger: true
  - get: rm-action-service-source
    passed: [rm-action-service-preprod-deploy]
    trigger: true
  - get: rm-actionexporter-service-source
    passed: [rm-actionexporter-service-preprod-deploy]
    trigger: true
  - get: rm-case-service-source
    passed: [rm-case-service-preprod-deploy]
    trigger: true
  - get: rm-collection-exercise-service-source
    passed: [rm-collection-exercise-preprod-deploy]
    trigger: true
  - get: iac-service-source
    passed: [iac-service-preprod-deploy]
    trigger: true
  - get: rm-notify-gateway-source
    passed: [rm-notify-gateway-preprod-deploy]
    trigger: true
  - get: rm-sample-service-source
    passed: [rm-sample-service-preprod-deploy]
    trigger: true
  - get: rm-sdx-gateway-source
    passed: [rm-sdx-gateway-preprod-deploy]
    trigger: true
  - get: rm-survey-service-source
    passed: [rm-survey-service-preprod-deploy]
    trigger: true
  - get: sdc-uaa-source
    passed: [sdc-uaa-preprod-deploy]
    trigger: true
  - task: smoke-test
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: alpine
      run:
        path: sh
        args:
        - -exc
        - echo "Smoke test placeholder"

- name: prod-trigger
  disable_manual_trigger: true
  plan:
  - get: prod-deploy-trigger
    trigger: true
  - get: ras-party-source
    passed: [preprod-smoke-tests]
  - get: ras-backstage-source
    passed: [preprod-smoke-tests]
  - get: ras-frontstage-source
    passed: [preprod-smoke-tests]
  - get: django-oauth2-test-source
    passed: [preprod-smoke-tests]
  - get: response-operations-ui-source
    passed: [preprod-smoke-tests]
  - get: ras-secure-message-source
    passed: [preprod-smoke-tests]
  - get: ras-collection-instrument-source
    passed: [preprod-smoke-tests]
  - get: rm-action-service-source
    passed: [preprod-smoke-tests]
  - get: rm-actionexporter-service-source
    passed: [preprod-smoke-tests]
  - get: rm-case-service-source
    passed: [preprod-smoke-tests]
  - get: rm-collection-exercise-service-source
    passed: [preprod-smoke-tests]
  - get: iac-service-source
    passed: [preprod-smoke-tests]
  - get: rm-notify-gateway-source
    passed: [preprod-smoke-tests]
  - get: rm-sample-service-source
    passed: [preprod-smoke-tests]
  - get: rm-sdx-gateway-source
    passed: [preprod-smoke-tests]
  - get: rm-survey-service-source
    passed: [preprod-smoke-tests]
  - get: sdc-uaa-source
    passed: [preprod-smoke-tests]

### START prod SPACE DEPLOYMENTS
- name: ras-party-prod-deploy
  disable_manual_trigger: true
  serial_groups: [ras-party-prod-deploy]
  plan:
  - get: ras-party-source
    trigger: true
    passed: [prod-trigger]
  - put: create-database
    resource: cf-cli-resource-prod
    params:
      command: create-service
      service: rds
      plan: shared-psql
      service_instance: ras-party-db
      timeout: 300
      wait_for_service: true
  - put: push-app
    resource: cf-resource-prod
    params:
      current_app_name: ras-party-concourse-prod
      manifest: ras-party-source/manifest.yml
      path: ras-party-source
      environment_variables:
        <<: *prod_security_user
        <<: *prod_service_endpoints_for_python
        RAS_NOTIFY_CONFIRM_PASSWORD_CHANGE_TEMPLATE: ba41c152-ad96-4255-9456-9e42de83f510
        RAS_NOTIFY_EMAIL_VERIFICATION_TEMPLATE: 53c59576-8c3b-4298-99d1-b245ddd28500
        RAS_NOTIFY_REQUEST_PASSWORD_CHANGE_TEMPLATE: c45c59ff-7771-4de4-a66b-ce50b108390a
        RAS_NOTIFY_SERVICE_URL: http://rm-notify-gateway-concourse-prod.apps.devtest.onsclofo.uk/emails/

- name: ras-secure-message-prod-deploy
  disable_manual_trigger: true
  serial_groups: [ras-secure-message-prod-deploy]
  plan:
  - get: ras-secure-message-source
    trigger: true
    passed: [prod-trigger]
  - put: create-database
    resource: cf-cli-resource-prod
    params:
      command: create-service
      service: rds
      plan: shared-psql
      service_instance: secure-message-db
      timeout: 300
      wait_for_service: true
  - put: cf-resource-prod
    params:
      current_app_name: ras-secure-message-concourse-prod
      manifest: ras-secure-message-source/manifest.yml
      path: ras-secure-message-source
      environment_variables:
        <<: *prod_security_user
        <<: *prod_service_endpoints_for_python
        JWT_ALGORITHM: 'HS256'
        JWT_SECRET: ((prod_jwt_secret))
        NOTIFICATION_API_KEY: ((test_notify_api_key))
        NOTIFICATION_TEMPLATE_ID: 'f6404844-a994-428c-a5d7-45a4e1cfff4b'
        NOTIFY_VIA_GOV_NOTIFY: '1'
        RM_NOTIFY_GATEWAY_URL: 'http://rm-notify-gateway-concourse-prod.apps.devtest.onsclofo.uk/emails/'
        RAS_SM_PATH: '/home/vcap/app'
        SERVICE_ID: 'ce3674b1-7b08-4377-a6a7-05b5722d4ea5'
        UAA_URL: 'http://uaa-concourse-prod.apps.devtest.onsclofo.uk'
        CLIENT_ID: 'secure_message'
        CLIENT_SECRET: ((prod_secure_message_client_secret))
        USE_UAA: '1'

- name: ras-backstage-prod-deploy
  disable_manual_trigger: true
  serial_groups: [ras-backstage-prod-deploy]
  plan:
  - get: ras-backstage-source
    trigger: true
    passed: [prod-trigger]
  - put: cf-resource-prod
    params:
      current_app_name: ras-backstage-concourse-prod
      manifest: ras-backstage-source/manifest.yml
      path: ras-backstage-source
      environment_variables:
        <<: *prod_security_user
        <<: *prod_service_endpoints_for_python
        RAS_SECURE_MESSAGING_JWT_SECRET: ((prod_jwt_secret))
        UAA_CLIENT_ID: 'response_operations'
        UAA_CLIENT_SECRET: ((prod_response_operations_client_secret))
        UAA_SERVICE_URL: 'http://uaa-concourse-prod.apps.devtest.onsclofo.uk'
        USE_UAA: '1'

- name: ras-collection-instrument-prod-deploy
  disable_manual_trigger: true
  serial_groups: [ras-collection-instrument-prod-deploy]
  plan:
  - get: ras-collection-instrument-source
    trigger: true
    passed: [prod-trigger]
  - get: ras-deploy
  - put: create-rm-rabbitmq
    resource: cf-cli-resource-prod
    params:
      command: create-service
      service: rabbitmq
      plan: standard
      service_instance: rm-rabbitmq
      timeout: 1800
      wait_for_service: true
  - put: create-sdx-rabbitmq
    resource: cf-cli-resource-prod
    params:
      command: create-service
      service: rabbitmq
      plan: standard
      service_instance: sdx-rabbitmq
      timeout: 1800
      wait_for_service: true
  - put: create-database
    resource: cf-cli-resource-prod
    params:
      command: create-service
      service: rds
      plan: shared-psql
      service_instance: ras-ci-db
      timeout: 300
      wait_for_service: true
  - put: cf-resource-prod
    params:
      current_app_name: ras-collection-instrument-concourse-prod
      manifest: ras-collection-instrument-source/manifest-ci.yml
      path: ras-collection-instrument-source
      environment_variables:
        <<: *prod_security_user
        <<: *prod_service_endpoints_for_python
        JSON_SECRET_KEYS: ((prod_json_secret_keys))
        ONS_CRYPTOKEY: ((prod_collection_instrument_encryption_key))
        RABBITMQ_AMQP_COLLECTION_INSTRUMENT: ((prod_rabbitmq_amqp_collection_instrument)) # What is this queue?
        RABBITMQ_AMQP_SURVEY_RESPONSE: ((prod_rabbitmq_amqp_survey_response))

- name: ras-frontstage-prod-deploy
  disable_manual_trigger: true
  serial_groups: [ras-frontstage-prod-deploy]
  plan:
  - get: ras-frontstage-source
    trigger: true
    passed: [prod-trigger]
  - <<: *prod_create_rm_redis
  - put: cf-resource-prod
    params:
      current_app_name: ras-frontstage-concourse-prod
      manifest: ras-frontstage-source/manifest.yml
      path: ras-frontstage-source
      environment_variables:
        <<: *prod_security_user
        <<: *prod_service_endpoints_for_python
        EQ_URL: 'https://eq-test/session?token='
        JSON_SECRET_KEYS: ((prod_json_secret_keys))
        JWT_SECRET: ((prod_jwt_secret))
        OAUTH_CLIENT_ID: 'ons@ons.gov'
        OAUTH_CLIENT_SECRET: 'password'
        SECRET_KEY: ((prod_enrolement_code_encryption_key))

- name: django-oauth2-test-prod-deploy
  disable_manual_trigger: true
  serial_groups: [django-oauth2-test-prod-deploy]
  plan:
  - get: django-oauth2-test-source
    trigger: true
    passed: [prod-trigger]
  - get: ras-deploy
  - put: create-database
    resource: cf-cli-resource-prod
    params:
      command: create-service
      service: rds
      plan: shared-psql
      service_instance: oauth-db
      timeout: 300
      wait_for_service: true
  # Create git_info file for info end point
  - task: git-info
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: paasmule/curl-ssl-git
          tag: "latest"
      inputs:
        - name: django-oauth2-test-source
      outputs:
        - name: django-oauth2-test-source-git-info
      run:
        path: sh
        args:
        - -exc
        - |
          cd django-oauth2-test-source
          branch=$(git rev-parse --abbrev-ref HEAD)
          url=$(git config --get remote.origin.url)
          commit=$(git rev-parse HEAD)
          repo=$(basename `git rev-parse --show-toplevel`)
          when=`date --utc +%FT%TZ`
          output=git_info
          echo '{' > ${output}
          echo   \"origin\": \"${url}\", >> ${output}
          echo   \"commit\": \"${commit}\", >> ${output}
          echo   \"branch\": \"${branch}\", >> ${output}
          echo   \"name\": \"${repo}\", >> ${output}
          echo   \"built\": \"${when}\" >> ${output}
          echo '}' >> ${output}
          cd ..
          cp -r django-oauth2-test-source/* django-oauth2-test-source-git-info
  - put: cf-resource-prod
    params:
      current_app_name: django-oauth2-test-concourse-prod
      manifest: django-oauth2-test-source-git-info/manifest.yml
      path: django-oauth2-test-source-git-info
      environment_variables:
        <<: *prod_security_user
        CSRF_ENABLED: 'True'
        DEBUG: 'False'
        DJANGO_SETTINGS_MODULE: 'proj.settings.cloud_foundry_settings'
        OAUTH2_SUPER_USER: ((prod_oauth2_super_user))
        OAUTH2_SUPER_USER_EMAIL: ((prod_oauth2_super_user_email))
        OAUTH2_SUPER_USER_PASSWORD: ((prod_oauth2_super_user_password))
        SECRET_KEY: ((prod_jwt_secret))
        TESTING: 'False'
  - task: create-super-user
    file: ras-deploy/tasks/django-oauth2-test/create_default_user.yml
    params:
      CLOUDFOUNDRY_API: ((cloudfoundry_api))
      CLOUDFOUNDRY_EMAIL: ((cloudfoundry_email))
      CLOUDFOUNDRY_PASSWORD: ((cloudfoundry_password))
      CLOUDFOUNDRY_ORG: rmras
      CLOUDFOUNDRY_SPACE: concourse-prod
      APP_NAME: django-oauth2-test-concourse-prod

- name: response-operations-ui-prod-deploy
  disable_manual_trigger: true
  serial_groups: [response-operations-ui-prod-deploy]
  plan:
  - get: response-operations-ui-source
    trigger: true
    passed: [prod-trigger]
  - put: create-redis
    resource: cf-cli-resource-prod
    params:
      command: create-service
      service: elasticache-broker
      plan: small
      service_instance: ras-redis
      timeout: 1800
      wait_for_service: true
  - put: cf-resource-prod
    params:
      current_app_name: response-operations-ui-concourse-prod
      manifest: response-operations-ui-source/manifest.yml
      path: response-operations-ui-source
      environment_variables:
        <<: *prod_service_endpoints_for_python
        <<: *prod_security_user
        RAS_SECURE_MESSAGING_JWT_SECRET: ((prod_jwt_secret))
        REDIS_SERVICE: ras-redis
        UAA_CLIENT_ID: 'response_operations'
        UAA_CLIENT_SECRET: ((prod_response_operations_client_secret))

- name: rm-action-service-prod-deploy
  disable_manual_trigger: true
  serial_groups: [rm-action-service-prod-deploy]
  plan:
  - get: rm-action-service-source
    trigger: true
    passed: [prod-trigger]
  - aggregate:
    - <<: *prod_create_rm_pg_db
    - <<: *prod_create_rm_redis
    - <<: *prod_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-action-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-action-service-source/.maven.settings.xml install -Ddockerfile.skip -f rm-action-service-source/pom.xml
            cp -r rm-action-service-source/target/ .
  - put: cf-resource-prod
    params:
      current_app_name: rm-action-service-concourse-prod
      manifest: rm-action-service-source/manifest-no-envs.yml
      path: target/actionsvc*.jar
      environment_variables:
        <<: *prod_security_user
        <<: *prod_service_endpoints_for_java
        endpoints_enabled: 'false'

- name: rm-actionexporter-service-prod-deploy
  disable_manual_trigger: true
  serial_groups: [rm-actionexporter-service-prod-deploy]
  plan:
  - get: rm-actionexporter-service-source
    trigger: true
    passed: [prod-trigger]
  - aggregate:
    - <<: *prod_create_rm_pg_db
    - <<: *prod_create_rm_redis
    - <<: *prod_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-actionexporter-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-actionexporter-service-source/.maven.settings.xml install -Ddockerfile.skip -f rm-actionexporter-service-source/pom.xml
            cp -r rm-actionexporter-service-source/target/ .
  - put: cf-resource-prod
    params:
      current_app_name: rm-actionexporter-service-concourse-prod
      manifest: rm-actionexporter-service-source/manifest.yml
      path: target/actionexportersvc*.jar
      environment_variables:
        <<: *prod_security_user
        endpoints_enabled: 'false'
        exportSchedule_cronExpression: '0 * * * * ?'
        sftp_host: ((sftp_host))
        sftp_password: ((actionexporter_sftp_password))
        sftp_port: '22'
        sftp_username: ((actionexporter_sftp_username))

- name: rm-case-service-prod-deploy
  disable_manual_trigger: true
  serial_groups: [rm-case-service-prod-deploy]
  plan:
  - get: rm-case-service-source
    trigger: true
    passed: [prod-trigger]
  - aggregate:
    - <<: *prod_create_rm_pg_db
    - <<: *prod_create_rm_redis
    - <<: *prod_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-case-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-case-service-source/.maven.settings.xml install -Ddockerfile.skip -f rm-case-service-source/pom.xml
            cp -r rm-case-service-source/target/ .
  - put: cf-resource-prod
    params:
      current_app_name: rm-case-service-concourse-prod
      manifest: rm-case-service-source/manifest-no-envs.yml
      path: target/casesvc*.jar
      environment_variables:
        <<: *prod_security_user
        <<: *prod_service_endpoints_for_java
        endpoints_enabled: 'false'

- name: rm-collection-exercise-prod-deploy
  disable_manual_trigger: true
  serial_groups: [rm-collection-exercise-prod-deploy]
  plan:
  - get: rm-collection-exercise-service-source
    trigger: true
    passed: [prod-trigger]
  - aggregate:
    - <<: *prod_create_rm_pg_db
    - <<: *prod_create_rm_redis
    - <<: *prod_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-collection-exercise-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-collection-exercise-service-source/.maven.settings.xml install -Ddockerfile.skip -Ddocker.skip -DskipITs -f rm-collection-exercise-service-source/pom.xml
            cp -r rm-collection-exercise-service-source/target/ .
  - put: cf-resource-prod
    params:
      current_app_name: rm-collection-exercise-service-concourse-prod
      manifest: rm-collection-exercise-service-source/manifest-no-envs.yml
      path: target/collectionexercisesvc*.jar
      environment_variables:
        <<: *prod_security_user
        <<: *prod_service_endpoints_for_java
        endpoints_enabled: 'false'
        SCHEDULES_VALIDATION_SCHEDULE_DELAY_MILLI_SECONDS: '1000'
        SCHEDULES_DISTRIBUTION_SCHEDULE_DELAY_MILLI_SECONDS: '1000'

- name: iac-service-prod-deploy
  disable_manual_trigger: true
  serial_groups: [iac-service-prod-deploy]
  plan:
  - get: iac-service-source
    trigger: true
    passed: [prod-trigger]
  - aggregate:
    - <<: *prod_create_rm_pg_db
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: iac-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings iac-service-source/.maven.settings.xml install -Ddockerfile.skip -f iac-service-source/pom.xml
            cp -r iac-service-source/target/ .
  - put: cf-resource-prod
    params:
      current_app_name: iac-service-concourse-prod
      manifest: iac-service-source/manifest-no-envs.yml
      path: target/iacsvc*.jar
      environment_variables:
        <<: *prod_security_user
        <<: *prod_service_endpoints_for_java
        endpoints_enabled: 'false'

- name: rm-notify-gateway-prod-deploy
  disable_manual_trigger: true
  serial_groups: [rm-notify-gateway-prod-deploy]
  plan:
  - get: rm-notify-gateway-source
    trigger: true
    passed: [prod-trigger]
  - aggregate:
    - <<: *prod_create_rm_pg_db
    - <<: *prod_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-notify-gateway-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-notify-gateway-source/.maven.settings.xml install -Ddockerfile.skip -f rm-notify-gateway-source/pom.xml
            cp -r rm-notify-gateway-source/target/ .
  - put: cf-resource-prod
    params:
      current_app_name: rm-notify-gateway-concourse-prod
      manifest: rm-notify-gateway-source/manifest.yml
      path: target/notifygatewaysvc*.jar
      environment_variables:
        <<: *prod_security_user
        endpoints_enabled: 'false'
        notify_apiKey: ((test_notify_api_key))
        notify_censusUacSmsTemplateId: '966731dc-ef2e-41ad-a828-8cdd95c81ebc'
        notify_enabled: 'false'
        notify_onsSurveysRasEmailReminderTemplateId: '19a0aa89-797f-4a34-ad54-267fd581f2ef'

- name: rm-sample-service-prod-deploy
  disable_manual_trigger: true
  serial_groups: [rm-sample-service-prod-deploy]
  plan:
  - get: rm-sample-service-source
    trigger: true
    passed: [prod-trigger]
  - aggregate:
    - <<: *prod_create_rm_pg_db
    - <<: *prod_create_rm_redis
    - <<: *prod_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-sample-service-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-sample-service-source/.maven.settings.xml install -Ddockerfile.skip -Ddocker.skip -DskipITs -f rm-sample-service-source/pom.xml
            cp -r rm-sample-service-source/target/ .
  - put: cf-resource-prod
    params:
      current_app_name: rm-sample-service-concourse-prod
      manifest: rm-sample-service-source/manifest-no-envs.yml
      path: target/samplesvc*.jar
      environment_variables:
        <<: *prod_security_user
        <<: *prod_service_endpoints_for_java
        SAMPLE_UNIT_DISTRIBUTION_DELAY_MILLI_SECONDS: '1000'
        endpoints_enabled: 'false'
        exportSchedule_cronExpression: '0 0/5 * * * ?'
        sftp_host: ((sftp_host))
        sftp_password: ((sample_sftp_password))
        sftp_port: '22'
        sftp_username: ((sample_sftp_username))

- name: rm-sdx-gateway-prod-deploy
  disable_manual_trigger: true
  serial_groups: [rm-sdx-gateway-prod-deploy]
  plan:
  - get: rm-sdx-gateway-source
    trigger: true
    passed: [prod-trigger]
  - aggregate:
    - <<: *prod_create_rm_redis
    - <<: *prod_create_rm_rabbitmq
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: maven
            tag: 3.3.9-jdk-8
        inputs:
          - name: rm-sdx-gateway-source
        outputs:
          - name: target
            path: target
        run:
          path: sh
          args:
          - -exc
          - |
            mvn --settings rm-sdx-gateway-source/.maven.settings.xml install -Ddockerfile.skip -f rm-sdx-gateway-source/pom.xml
            cp -r rm-sdx-gateway-source/target/ .
  - put: cf-resource-prod
    params:
      current_app_name: rm-sdx-gateway-concourse-prod
      manifest: rm-sdx-gateway-source/manifest.yml
      path: target/sdxgatewaysvc*.jar
      environment_variables:
        <<: *prod_security_user
        endpoints_enabled: 'false'

- name: rm-survey-service-prod-deploy
  disable_manual_trigger: true
  serial_groups: [rm-survey-service-prod-deploy]
  plan:
  - get: rm-survey-service-source
    trigger: true
    passed: [prod-trigger]
  - aggregate:
    - <<: *prod_create_rm_pg_db
    - task: build
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: golang
        inputs:
          - name: rm-survey-service-source
        outputs:
          - name: rm-survey-service-build
            path: rm-survey-service
        run:
          path: sh
          args:
          - -exc
          - |
            mkdir -p /go/src/github.com/ONSdigital/
            cp -r rm-survey-service-source /go/src/github.com/ONSdigital/rm-survey-service
            make -C /go/src/github.com/ONSdigital/rm-survey-service
            cp -r /go/src/github.com/ONSdigital/rm-survey-service/ .
  - put: cf-resource-prod
    params:
      current_app_name: rm-survey-service-concourse-prod
      manifest: rm-survey-service-source/manifest.yml
      path: rm-survey-service-build
      environment_variables:
        <<: *prod_security_user
        MIGRATION_SOURCE: 'file://db-migrations'

- name: sdc-uaa-prod-deploy
  disable_manual_trigger: true
  serial_groups: [sdc-uaa-prod-deploy]
  plan:
  - get: sdc-uaa-source
    trigger: true
    passed: [prod-trigger]
  - task: build
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: sdcplatform/maven-cf-cli-docker
      inputs:
        - name: sdc-uaa-source
      outputs:
        - name: sdc-uaa-build
          path: sdc-uaa-build
      params:
        UAA_PRIVATE_KEY: ((prod_uaa_private_key))
        UAA_CERTIFICATE: ((prod_uaa_certificate))
        UAA_PRIVATE_KEY_PASSWORD: ((prod_uaa_private_key_password))
        JENKINS_CF_USERNAME: ((cloudfoundry_email))
        JENKINS_CF_PASSWORD: ((cloudfoundry_password))
        API_ENDPOINT: ((cloudfoundry_api))
        ORG: rmras
        SPACE: concourse-prod
        UAA_ID: ((prod_uaa_id))
        UAA_SECRET: ((prod_uaa_secret))
        UAA_JWT_SIGNING_KEY: ((prod_uaa_jwt_signing_key))
        UAA_JWT_VERIFICATION_KEY: ((prod_uaa_jwt_verification_key))
        UAA_URL: 'http://uaa-concourse-prod.apps.devtest.onsclofo.uk'
        LOGIN_URL: 'http://uaa-concourse-prod.apps.devtest.onsclofo.uk'
        ZONE_URL: 'uaa-concourse-prod.apps.devtest.onsclofo.uk'
        ADMIN_SECRET: ((prod_uaa_admin_secret))
        LOGIN_SECRET: ((prod_uaa_login_secret))
      run:
        path: sh
        args:
        - -exc
        - |
          (cd sdc-uaa-source && ls && sh deploy-uaa-pre-steps.sh dev)
          mvn install -f sdc-uaa-source/pom.xml
          cp -r sdc-uaa-source/* sdc-uaa-build
  - put: cf-resource-prod
    params:
      current_app_name: sdc-uaa-concourse-prod
      manifest: sdc-uaa-build/uaa-cf-application.yml
      #### EXTRACT ME ####
  - task: create-secure-message-client
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: kennethreitz/pipenv
      inputs:
        - name: sdc-uaa-source
      params:
        SPACE: concourse-prod
        CLIENT: secure_message
        PASSWORD: ((prod_secure_message_client_secret))
        ADMIN_SECRET: ((prod_uaa_admin_secret))
        UAA_URL: 'uaa-concourse-prod.apps.devtest.onsclofo.uk'
      run:
        dir: sdc-uaa-source
        path: sh
        args:
        - './scripts/jenkins/add_client.sh'
  - task: create-response_operations-client
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: kennethreitz/pipenv
      inputs:
        - name: sdc-uaa-source
      params:
        SPACE: concourse-prod
        CLIENT: response_operations
        PASSWORD: ((prod_response_operations_client_secret))
        ADMIN_SECRET: ((prod_uaa_admin_secret))
        UAA_URL: 'uaa-concourse-prod.apps.devtest.onsclofo.uk'
      run:
        dir: sdc-uaa-source
        path: sh
        args:
        - './scripts/jenkins/add_client.sh'
  - task: create-uaa-user
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: kennethreitz/pipenv
      inputs:
        - name: sdc-uaa-source
      params:
        SPACE: concourse-prod
        USERNAME: uaa_user
        PASSWORD: ((prod_uaa_user_password))
        EMAIL: ons@ons.gov
        FIRSTNAME: uaa
        LASTNAME: user
        ADMIN_SECRET: ((prod_uaa_admin_secret))
        UAA_URL: 'uaa-concourse-prod.apps.devtest.onsclofo.uk'
      run:
        dir: sdc-uaa-source
        path: sh
        args:
        - './scripts/jenkins/add_user.sh'
### END prod SPACE DEPLOYMENTS

- name: prod-smoke-tests
  serial_groups: *prod_all_services
  plan:
  - get: ras-deploy
  - get: rasrm-acceptance-tests-source
    trigger: true
  - get: ras-party-source
    passed: [ras-party-prod-deploy]
    trigger: true
  - get: ras-backstage-source
    passed: [ras-backstage-prod-deploy]
    trigger: true
  - get: ras-frontstage-source
    passed: [ras-frontstage-prod-deploy]
    trigger: true
  - get: django-oauth2-test-source
    passed: [django-oauth2-test-prod-deploy]
    trigger: true
  - get: response-operations-ui-source
    passed: [response-operations-ui-prod-deploy]
    trigger: true
  - get: ras-secure-message-source
    passed: [ras-secure-message-prod-deploy]
    trigger: true
  - get: ras-collection-instrument-source
    passed: [ras-collection-instrument-prod-deploy]
    trigger: true
  - get: rm-action-service-source
    passed: [rm-action-service-prod-deploy]
    trigger: true
  - get: rm-actionexporter-service-source
    passed: [rm-actionexporter-service-prod-deploy]
    trigger: true
  - get: rm-case-service-source
    passed: [rm-case-service-prod-deploy]
    trigger: true
  - get: rm-collection-exercise-service-source
    passed: [rm-collection-exercise-prod-deploy]
    trigger: true
  - get: iac-service-source
    passed: [iac-service-prod-deploy]
    trigger: true
  - get: rm-notify-gateway-source
    passed: [rm-notify-gateway-prod-deploy]
    trigger: true
  - get: rm-sample-service-source
    passed: [rm-sample-service-prod-deploy]
    trigger: true
  - get: rm-sdx-gateway-source
    passed: [rm-sdx-gateway-prod-deploy]
    trigger: true
  - get: rm-survey-service-source
    passed: [rm-survey-service-prod-deploy]
    trigger: true
  - get: sdc-uaa-source
    passed: [sdc-uaa-prod-deploy]
    trigger: true
  - task: smoke-test
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: alpine
      run:
        path: sh
        args:
        - -exc
        - echo "Smoke test placeholder"
